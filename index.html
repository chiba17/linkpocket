<html lang="ja"><head><script>(function(firebaseConfig, initialAuthToken, appId) {
        window.__firebase_config = firebaseConfig;
        window.__initial_auth_token = initialAuthToken;
        window.__app_id = appId;
            })("\n{\n  \"apiKey\": \"AIzaSyCqyCcs2R2e7AegGjvFAwG98wlamtbHvZY\",\n  \"authDomain\": \"bard-frontend.firebaseapp.com\",\n  \"projectId\": \"bard-frontend\",\n  \"storageBucket\": \"bard-frontend.firebasestorage.app\",\n  \"messagingSenderId\": \"175205271074\",\n  \"appId\": \"1:175205271074:web:2b7bd4d34d33bf38e6ec7b\"\n}\n","eyJhbGciOiJSUzI1NiIsImtpZCI6ImQ4ZWQ3YTU3YzkyMTgwYzk0YjI2MzE3ZjMzYjY5MWE4MWRlNzYzNTEiLCJ0eXAiOiJKV1QifQ.eyJzdWIiOiJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0BiYXJkLWZyb250ZW5kLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwiYXVkIjoiaHR0cHM6Ly9pZGVudGl0eXRvb2xraXQuZ29vZ2xlYXBpcy5jb20vZ29vZ2xlLmlkZW50aXR5LmlkZW50aXR5dG9vbGtpdC52MS5JZGVudGl0eVRvb2xraXQiLCJ1aWQiOiIwNzE1ODkwNzg2MDAyMzE4NTExOCIsImlzcyI6ImZpcmViYXNlLWFkbWluc2RrLWZic3ZjQGJhcmQtZnJvbnRlbmQuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJjbGFpbXMiOnsiYXBwSWQiOiJjX2M0MzFmMTJiYzI1OGVjMTdfaW5kZXguaHRtbC0zNTYifSwiZXhwIjoxNzY1NzMyMTE1LCJpYXQiOjE3NjU3Mjg1MTUsImFsZyI6IlJTMjU2In0.m_XcZCCugefwqwbjq0Y1PNUxcAf7uHA9Li2KxPj8VKMGxrh9Ls9e1srJ6supypxmtyWuEZJUW6G8-IxfZAVlA-2a5a1UdfVXe1i9wWsJEdMQgDEu9vhyn_cAYOVVizoQh97bIvNGX9PPrcXAbYrQb-pqBLk1mpKSQWDM9dsB4zc0gq22plmr64G74RhBnBOH1cQHOeuSvaYPpLhtxH78_yFe723_vLqHoSH7PeLSc5f_HrHCiHPRCumXeKBF-3ZQziUy4lYFqTpHlk8I6LWmVHJmKhmlRMmArUM-yqDUEL29YG3bccZqtNm6-SnFqX4RJJCewRctxYmt040fWQIQ4g","c_c431f12bc258ec17_index.html-356")</script><script>'use strict';var h=typeof Object.defineProperties=="function"?Object.defineProperty:function(a,b,d){if(a==Array.prototype||a==Object.prototype)return a;a[b]=d.value;return a};function l(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var d=a[b];if(d&&d.Math==Math)return d}throw Error("Cannot find global object");}var n=l(this);
function p(a,b){if(b)a:{var d=n;a=a.split(".");for(var c=0;c<a.length-1;c++){var e=a[c];if(!(e in d))break a;d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&b!=null&&h(d,a,{configurable:!0,writable:!0,value:b})}}function r(a){function b(c){return a.next(c)}function d(c){return a.throw(c)}return new Promise(function(c,e){function f(g){g.done?c(g.value):Promise.resolve(g.value).then(b,d).then(f,e)}f(a.next())})}function t(a){return r(a())}
p("Object.values",function(a){return a?a:function(b){var d=[],c;for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&d.push(b[c]);return d}});p("Array.prototype.includes",function(a){return a?a:function(b,d){var c=this;c instanceof String&&(c=String(c));var e=c.length;d=d||0;for(d<0&&(d=Math.max(d+e,0));d<e;d++){var f=c[d];if(f===b||Object.is(f,b))return!0}return!1}});/*

 MIT License

 Copyright (c) 2017-2023 W.Y.

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.

*/
function u(a,b){const d=a.style;b.backgroundColor&&(d.backgroundColor=b.backgroundColor);b.width&&(d.width=`${b.width}px`);b.height&&(d.height=`${b.height}px`);const c=b.style;c!=null&&Object.keys(c).forEach(e=>{d[e]=c[e]})};var v=(()=>{let a=0;return()=>{a+=1;return`u${`0000${(Math.random()*1679616<<0).toString(36)}`.slice(-4)}${a}`}})();function w(a){const b=[];for(let d=0,c=a.length;d<c;d++)b.push(a[d]);return b}let x=null;function y(a={}){return x?x:a.l?x=a.l:x=w(window.getComputedStyle(document.documentElement))}function z(a,b){return(a=(a.ownerDocument.defaultView||window).getComputedStyle(a).getPropertyValue(b))?parseFloat(a.replace("px","")):0}
function A(a,b={}){var d;if(!(d=b.width)){d=z(a,"border-left-width");var c=z(a,"border-right-width");d=a.clientWidth+d+c}(b=b.height)||(b=z(a,"border-top-width"),c=z(a,"border-bottom-width"),b=a.clientHeight+b+c);return{width:d,height:b}}function B(a){return new Promise((b,d)=>{const c=new Image;c.onload=()=>{c.decode().then(()=>{requestAnimationFrame(()=>b(c))})};c.onerror=d;c.crossOrigin="anonymous";c.decoding="async";c.src=a})}
function C(a){return t(function*(){return Promise.resolve().then(()=>(new XMLSerializer).serializeToString(a)).then(encodeURIComponent).then(b=>`data:image/svg+xml;charset=utf-8,${b}`)})}
function D(a,b,d){return t(function*(){const c=document.createElementNS("http://www.w3.org/2000/svg","svg"),e=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");c.setAttribute("width",`${b}`);c.setAttribute("height",`${d}`);c.setAttribute("viewBox",`0 0 ${b} ${d}`);e.setAttribute("width","100%");e.setAttribute("height","100%");e.setAttribute("x","0");e.setAttribute("y","0");e.setAttribute("externalResourcesRequired","true");c.appendChild(e);e.appendChild(a);return C(c)})}
var E=(a,b)=>{if(a instanceof b)return!0;a=Object.getPrototypeOf(a);return a===null?!1:a.constructor.name===b.name||E(a,b)};function F(a,b){return y(b).map(d=>{const c=a.getPropertyValue(d),e=a.getPropertyPriority(d);return`${d}: ${c}${e?" !important":""};`}).join(" ")}
function G(a,b,d,c){a=window.getComputedStyle(a,d);var e=a.getPropertyValue("content");if(e!==""&&e!=="none"){var f=v();try{b.className=`${b.className} ${f}`}catch(k){return}e=document.createElement("style");var g=e.appendChild;d=`.${f}:${d}`;a.cssText?(c=a.getPropertyValue("content"),c=`${a.cssText} content: '${c.replace(/'|"/g,"")}';`):c=F(a,c);g.call(e,document.createTextNode(`${d}{${c}}`));b.appendChild(e)}};function H(a){return a.search(/^(data:)/)!==-1}function I(a,b,d){return t(function*(){const c=yield fetch(a,b);if(c.status===404)throw Error(`Resource "${c.url}" not found`);const e=yield c.blob();return new Promise((f,g)=>{const k=new FileReader;k.onerror=g;k.onloadend=()=>{try{f(d({o:c,result:k.result}))}catch(m){g(m)}};k.readAsDataURL(e)})})}const J={};function K(a,b,d){let c=a.replace(/\?.*/,"");d&&(c=a);/ttf|otf|eot|woff2?/i.test(c)&&(c=c.replace(/.*\//,""));return b?`[${b}]${c}`:c}
function L(a,b,d){return t(function*(){const c=K(a,b,d.C);if(J[c]!=null)return J[c];d.u&&(a+=(/\?/.test(a)?"&":"?")+(new Date).getTime());let e;try{const f=yield I(a,d.i,({o:g,result:k})=>{b||(b=g.headers.get("Content-Type")||"");return k.split(/,/)[1]});e=`data:${b};base64,${f}`}catch(f){e=d.B||""}return J[c]=e})};const M={P:"application/font-woff",R:"application/font-woff",N:"application/font-truetype",v:"application/vnd.ms-fontobject",H:"image/png",F:"image/jpeg",D:"image/jpeg",A:"image/gif",M:"image/tiff",L:"image/svg+xml",O:"image/webp"};function N(a){return(a=/\.([^./]*?)$/g.exec(a))?a[1]:""};function O(a){return t(function*(){const b=a.toDataURL();return b==="data:,"?a.cloneNode(!1):B(b)})}function aa(a,b){return t(function*(){if(a.currentSrc){var d=document.createElement("canvas");const c=d.getContext("2d");d.width=a.clientWidth;d.height=a.clientHeight;c==null||c.drawImage(a,0,0,d.width,d.height);d=d.toDataURL();return B(d)}d=a.poster;d=yield L(d,M[N(d).toLowerCase()]||"",b);return B(d)})}
function ba(a,b){return t(function*(){try{let d;if(a==null?0:(d=a.contentDocument)==null?0:d.body)return yield P(a.contentDocument.body,b,!0)}catch(d){}return a.cloneNode(!1)})}function ca(a,b){return t(function*(){return E(a,HTMLCanvasElement)?O(a):E(a,HTMLVideoElement)?aa(a,b):E(a,HTMLIFrameElement)?ba(a,b):a.cloneNode(a.tagName!=null&&a.tagName.toUpperCase()==="SVG")})}
function da(a,b,d){return t(function*(){if(b.tagName!=null&&b.tagName.toUpperCase()==="SVG")return b;let c=[];if(a.tagName!=null&&a.tagName.toUpperCase()==="SLOT"&&a.assignedNodes)c=w(a.assignedNodes());else{let e;if(E(a,HTMLIFrameElement)&&((e=a.contentDocument)==null?0:e.body))c=w(a.contentDocument.body.childNodes);else{let f;c=w(((f=a.shadowRoot)!=null?f:a).childNodes)}}if(c.length===0||E(a,HTMLVideoElement))return b;yield c.reduce((e,f)=>e.then(()=>P(f,d)).then(g=>{g&&b.appendChild(g)}),Promise.resolve());
return b})}function ea(a,b,d){const c=b.style;if(c){var e=window.getComputedStyle(a);e.cssText?(c.cssText=e.cssText,c.transformOrigin=e.transformOrigin):y(d).forEach(f=>{let g=e.getPropertyValue(f);f==="font-size"&&g.endsWith("px")&&(g=`${Math.floor(parseFloat(g.substring(0,g.length-2)))-.1}px`);E(a,HTMLIFrameElement)&&f==="display"&&g==="inline"&&(g="block");f==="d"&&b.getAttribute("d")&&(g=`path(${b.getAttribute("d")})`);c.setProperty(f,g,e.getPropertyPriority(f))})}}
function fa(a,b){E(a,HTMLSelectElement)&&(b=Array.from(b.children).find(d=>a.value===d.getAttribute("value")))&&b.setAttribute("selected","")}
function ha(a,b){return t(function*(){var d=a.querySelectorAll?a.querySelectorAll("use"):[];if(d.length===0)return a;var c={};for(var e=0;e<d.length;e++){var f=d[e].getAttribute("xlink:href");if(f){const g=document.querySelector(f);a.querySelector(f)||!g||c[f]||(c[f]=yield P(g,b,!0))}}d=Object.values(c);if(d.length){c=document.createElementNS("http://www.w3.org/1999/xhtml","svg");c.setAttribute("xmlns","http://www.w3.org/1999/xhtml");c.style.position="absolute";c.style.width="0";c.style.height="0";
c.style.overflow="hidden";c.style.display="none";e=document.createElementNS("http://www.w3.org/1999/xhtml","defs");c.appendChild(e);for(f=0;f<d.length;f++)e.appendChild(d[f]);a.appendChild(c)}return a})}
function P(a,b,d){return t(function*(){return d||!b.filter||b.filter(a)?Promise.resolve(a).then(c=>ca(c,b)).then(c=>da(a,c,b)).then(c=>{E(c,Element)&&(ea(a,c,b),G(a,c,":before",b),G(a,c,":after",b),E(a,HTMLTextAreaElement)&&(c.textContent=a.value),E(a,HTMLInputElement)&&c.setAttribute("value",a.value),fa(a,c));return c}).then(c=>ha(c,b)):null})};const Q=/url\((['"]?)([^'"]+?)\1\)/g,ia=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,ja=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function ka(a){const b=[];a.replace(Q,(d,c,e)=>{b.push(e);return d});return b.filter(d=>!H(d))}
function la(a,b,d,c){return t(function*(){try{const e=d?(new URL(b,d||void 0)).toString():b;let f;f=yield L(e,M[N(b).toLowerCase()]||"",c);return a.replace(new RegExp(`(url\\(['"]?)(${b.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")})(['"]?\\))`,"g"),`$1${f}$3`)}catch(e){}return a})}function ma(a,{I:b}){return b?a.replace(ja,d=>{for(;;){const [c,,e]=ia.exec(d)||[],f=c,g=e;if(!g)return"";if(g===b)return`src: ${f};`}}):a}
function R(a,b,d){return t(function*(){if(a.search(Q)===-1)return a;const c=ma(a,d);return ka(c).reduce((e,f)=>e.then(g=>la(g,f,b,d)),Promise.resolve(c))})};function S(a,b,d){return t(function*(){var c;const e=(c=b.style)==null?void 0:c.getPropertyValue(a);return e?(c=yield R(e,null,d),b.style.setProperty(a,c,b.style.getPropertyPriority(a)),!0):!1})}function na(a,b){return t(function*(){(yield S("background",a,b))||(yield S("background-image",a,b));(yield S("mask",a,b))||(yield S("-webkit-mask",a,b))||(yield S("mask-image",a,b))||(yield S("-webkit-mask-image",a,b))})}
function oa(a,b){return t(function*(){const d=E(a,HTMLImageElement);if(d&&!H(a.src)||E(a,SVGImageElement)&&!H(a.href.baseVal)){var c=d?a.src:a.href.baseVal,e=yield L(c,M[N(c).toLowerCase()]||"",b);yield new Promise((f,g)=>{a.onload=f;a.onerror=b.m?(...k)=>{try{f(b.m(...k))}catch(m){g(m)}}:g;a.decode&&(a.decode=f);a.loading==="lazy"&&(a.loading="eager");d?(a.srcset="",a.src=e):a.href.baseVal=e})}})}
function pa(a,b){return t(function*(){const d=w(a.childNodes).map(c=>T(c,b));yield Promise.all(d).then(()=>a)})}function T(a,b){return t(function*(){E(a,Element)&&(yield na(a,b),yield oa(a,b),yield pa(a,b))})};const U={};function V(a){return t(function*(){var b=U[a];if(b!=null)return b;b=yield(yield fetch(a)).text();b={url:a,cssText:b};return U[a]=b})}function W(a,b){return t(function*(){let d=a.cssText;const c=/url\(["']?([^"')]+)["']?\)/g,e=(d.match(/url\([^)]+\)/g)||[]).map(f=>t(function*(){let g=f.replace(c,"$1");g.startsWith("https://")||(g=(new URL(g,a.url)).href);return I(g,b.i,({result:k})=>{d=d.replace(f,`url(${k})`);return[f,k]})}));return Promise.all(e).then(()=>d)})}
function X(a){if(a==null)return[];const b=[];a=a.replace(/(\/\*[\s\S]*?\*\/)/gi,"");for(var d=RegExp("((@.*?keyframes [\\s\\S]*?){([\\s\\S]*?}\\s*?)})","gi");;){var c=d.exec(a);if(c===null)break;b.push(c[0])}a=a.replace(d,"");d=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi;for(c=RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");;){let e=d.exec(a);if(e===null)if(e=c.exec(a),e===null)break;else d.lastIndex=c.lastIndex;else c.lastIndex=
d.lastIndex;b.push(e[0])}return b}
function qa(a,b){return t(function*(){const d=[],c=[];a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach((f,g)=>{if(f.type===CSSRule.IMPORT_RULE){let k=g+1;f=V(f.href).then(m=>W(m,b)).then(m=>X(m).forEach(q=>{try{e.insertRule(q,q.startsWith("@import")?k+=1:e.cssRules.length)}catch(Da){}})).catch(()=>{});c.push(f)}})}catch(f){const g=a.find(k=>k.href==null)||document.styleSheets[0];e.href!=null&&c.push(V(e.href).then(k=>W(k,b)).then(k=>X(k).forEach(m=>{g.insertRule(m,g.cssRules.length)})).catch(()=>
{}))}});return Promise.all(c).then(()=>{a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach(f=>{d.push(f)})}catch(f){}});return d})})}function ra(a){return a.filter(b=>b.type===CSSRule.FONT_FACE_RULE).filter(b=>b.style.getPropertyValue("src").search(Q)!==-1)}function sa(a,b){return t(function*(){if(a.ownerDocument==null)throw Error("Provided element is not within a Document");var d=w(a.ownerDocument.styleSheets);d=yield qa(d,b);return ra(d)})}
function ta(a){function b(c){(c.style.fontFamily||getComputedStyle(c).fontFamily).split(",").forEach(e=>{d.add(e.trim().replace(/["']/g,""))});Array.from(c.children).forEach(e=>{e instanceof HTMLElement&&b(e)})}const d=new Set;b(a);return d}function ua(a,b){return t(function*(){const d=yield sa(a,b),c=ta(a);return(yield Promise.all(d.filter(e=>c.has(e.style.fontFamily.trim().replace(/["']/g,""))).map(e=>R(e.cssText,e.parentStyleSheet?e.parentStyleSheet.href:null,b)))).join("\n")})}
function va(a,b){return t(function*(){const d=b.j!=null?b.j:b.K?null:yield ua(a,b);if(d){const c=document.createElement("style");c.appendChild(document.createTextNode(d));a.firstChild?a.insertBefore(c,a.firstChild):a.appendChild(c)}})};function wa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b),e=yield P(a,b,!0);yield va(e,b);yield T(e,b);u(e,b);return yield D(e,d,c)})}
function xa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b);var e=yield wa(a,b);e=yield B(e);const f=document.createElement("canvas"),g=f.getContext("2d"),k=b.G||window.devicePixelRatio||1,m=b.h||d,q=b.g||c;f.width=m*k;f.height=q*k;!b.J&&(f.width>16384||f.height>16384)&&(f.width>16384&&f.height>16384?f.width>f.height?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=16384):f.width>16384?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=
16384));f.style.width=`${m}`;f.style.height=`${q}`;b.backgroundColor&&(g.fillStyle=b.backgroundColor,g.fillRect(0,0,f.width,f.height));g.drawImage(e,0,0,f.width,f.height);return f})}function ya(a,b={}){return t(function*(){return(yield xa(a,b)).toDataURL()})};const za=["gemini.google.com","corp.google.com","proxy.googlers.com"];function Y(){return document.body.querySelectorAll('[class*="animate"]').length>0}function Z(a){return t(function*(){try{return yield ya(a,{h:a.offsetWidth,g:a.offsetHeight})}catch(d){var b=a.offsetHeight;const c=document.createElement("canvas");c.width=a.offsetWidth;c.height=b;return c.toDataURL("image/png")}})}
function Aa(){return t(function*(){const a=document.body.offsetWidth,b=document.body.offsetHeight,d=document.body.cloneNode(!0);d.querySelectorAll('[class*="animate"]').forEach(c=>{c.classList.remove(...Array.from(c.classList).filter(e=>e.startsWith("animate")))});d.style.width=`${a}px`;d.style.height=`${b}px`;return d})}
function Ba(a){return t(function*(){let b=document.body;if(Y()){var d=yield Aa();b=d;document.body.appendChild(d)}d=yield Z(b);Y()&&document.body.removeChild(b);window.parent.postMessage({type:"SEND_SCREENSHOT",image:d,topOffset:document.documentElement.scrollTop},a.origin)})}function Ca(a){return t(function*(){const b={type:"SEND_SCREENSHOT_FOR_DATA_VISUALIZATION",image:yield Z(document.body),topOffset:0};window.parent.postMessage(b,a.origin)})}
window.addEventListener("message",a=>t(function*(){if(za.some(d=>a.origin.includes(d))){var b=a.data;b&&(b.type==="MAKE_SCREENSHOT"&&(yield Ba(a)),b.type==="MAKE_SCREENSHOT_FOR_DATA_VISUALIZATION"&&(yield Ca(a)))}}));
</script><script>(function() {
  // Ensure this script is executed only once
  if (window.firebaseAuthBridgeScriptLoaded) {
    return;
  }
  window.firebaseAuthBridgeScriptLoaded = true;

  let nextTokenPromiseId = 0;

  // Stores { resolve, reject } for ongoing token requests
  const pendingTokenPromises = {};

  // Listen for messages from the Host Application
  window.addEventListener('message', function(event) {

    const messageData = event.data;

  if (messageData && messageData.type === 'RESOLVE_NEW_FIREBASE_TOKEN') {
      const { success, token, error, promiseId } = messageData ?? {};
      if (pendingTokenPromises[promiseId]) {
        if (success) {
          pendingTokenPromises[promiseId].resolve(token);
        } else {
          pendingTokenPromises[promiseId].reject(new Error(error || 'Token refresh failed from host.'));
        }
        delete pendingTokenPromises[promiseId];
      }
    }
  });

  // Expose a function for the Generated App to request a new Firebase token
  window.requestNewFirebaseToken = function() {
    const currentPromiseId = nextTokenPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingTokenPromises[currentPromiseId] = { resolve, reject };
    });
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({
        type: 'REQUEST_NEW_FIREBASE_TOKEN',
        promiseId: currentPromiseId
      }, '*');
    } else {
      pendingTokenPromises[currentPromiseId].reject(new Error('No parent window to request token from.'));
      delete pendingTokenPromises[currentPromiseId];
    }
    return promise;
  };
})();</script><script>
let realOriginalGetUserMedia = null;
if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
  realOriginalGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
}

(function() {
  if (navigator.mediaDevices && navigator.mediaDevices.__proto__) {
    try {
      Object.defineProperty(navigator.mediaDevices.__proto__, 'getUserMedia', {
        get: function() {
          return undefined; // Or throw an error
        },
        configurable: false
      });
    } catch (error) {
      console.error("Error defining prototype getter:", error);
    }
  }
})();

(function() {
  const pendingMediaResolvers = {};
  let nextMediaPromiseId = 0;

  function requestMediaPermissions(constraints) {
    const mediaPromiseId = nextMediaPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingMediaResolvers[mediaPromiseId] = (granted) => {
        delete pendingMediaResolvers[mediaPromiseId];
        resolve(granted);
      };
    });

    window.parent.postMessage({
      type: 'requestMediaPermission',
      constraints: constraints,
      promiseId: mediaPromiseId,
    }, '*');

    return promise;
  }

  let originalGetUserMedia = realOriginalGetUserMedia;

  function interceptGetUserMedia() {
    if (navigator.mediaDevices) {
      Object.defineProperty(navigator.mediaDevices, 'getUserMedia', {
        value: function(constraints) {
          return requestMediaPermissions(constraints).then((granted) => {
            if (granted) {
              if (originalGetUserMedia) {
                return originalGetUserMedia(constraints);
              } else {
                throw new Error("Original getUserMedia not available.");
              }
            } else {
              throw new DOMException('Permission denied', 'NotAllowedError');
            }
          });
        },
        writable: false,
        configurable: false
      });
    }
  }

  interceptGetUserMedia();

  const observer = new MutationObserver(function(mutationsList, observer) {
    for (const mutation of mutationsList) {
      if (mutation.type === 'reconfigured' && mutation.name === 'getUserMedia' && mutation.object === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'attributes' && mutation.attributeName === 'getUserMedia' && mutation.target === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'childList' && mutation.addedNodes) {
        mutation.addedNodes.forEach(node => {
          if (node === navigator.mediaDevices) {
            interceptGetUserMedia();
          }
        });
      }
    }
  });

  function interceptSpeechRecognition() {
    if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
      return;
    }

    const OriginalSpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    const SpeechRecognitionWrapper = function(...args) {
      const recognizer = new OriginalSpeechRecognition(...args);
      const originalStart = recognizer.start.bind(recognizer);

      recognizer.start = function() {
        requestMediaPermissions({ audio: true }).then(granted => {
          if (granted) {
            originalStart();
          } else {
            const errorEvent = new SpeechRecognitionErrorEvent('error');
            errorEvent.error = 'not-allowed'; // This is the standard error for permission denial.
            recognizer.dispatchEvent(errorEvent);
          }
        });
      };

      return recognizer;
    };

    SpeechRecognitionWrapper.prototype = OriginalSpeechRecognition.prototype;
    SpeechRecognitionWrapper.prototype.constructor = SpeechRecognitionWrapper;

    if (window.SpeechRecognition) {
      window.SpeechRecognition = SpeechRecognitionWrapper;
    }
    if (window.webkitSpeechRecognition) {
      window.webkitSpeechRecognition = SpeechRecognitionWrapper;
    }
  }

  interceptSpeechRecognition();

  window.addEventListener('message', function(event) {
    if (event.data) {
      if (event.data.type === 'resolveMediaPermission') {
        const { promiseId, granted } = event.data;
        if (pendingMediaResolvers[promiseId]) {
          pendingMediaResolvers[promiseId](granted);
        }
      }
    }
  });

})();</script><script>((function(modelInformation) {
  const originalFetch = window.fetch;
  // TODO: b/421908508 - Move these out of the script and match all generative AI model calls.
  let googleLlmBaseApiUrls = [
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':streamGenerateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageEditModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageTransformModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.ttsModelName + ':generateContent',
  ];
  modelInformation.deprecatedTextModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':streamGenerateContent',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':generateContent',
    );
  });
  modelInformation.deprecatedImageModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predict',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predictLongRunning',
    );
  });

  const pendingFetchResolvers = {};
  let nextPromiseId = 0;

  function handleStringInput(input, optionsArgument) {
    const actualUrl = input;
    const fetchCallArgs = [actualUrl, optionsArgument];
    const effectiveOptions = optionsArgument || {};
    const bodyForApiKeyCheck = effectiveOptions.body;
    const bodyForPostMessage = effectiveOptions.body;
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  function handleRequestInput(input, optionsArgument) {
    const actualUrl = input.url;
    const fetchCallArgs = [input, optionsArgument];
    const effectiveOptions = { method: input.method, headers: new Headers(input.headers) };
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (optionsArgument) {
      if (optionsArgument.method) effectiveOptions.method = optionsArgument.method;
      if (optionsArgument.headers) effectiveOptions.headers = new Headers(optionsArgument.headers);
      if ('body' in optionsArgument) {
        bodyForApiKeyCheck = optionsArgument.body;
        bodyForPostMessage = optionsArgument.body;
      } else {
        bodyForApiKeyCheck = undefined;
        bodyForPostMessage = input.body;
      }
    } else {
      bodyForApiKeyCheck = undefined;
      bodyForPostMessage = input.body;
    }
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  window.fetch = function(input, optionsArgument) {
    let actualUrl;
    let fetchCallArgs;
    let effectiveOptions = {};
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (typeof input === 'string') {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleStringInput(input, optionsArgument));
    } else if (input instanceof Request) {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleRequestInput(input, optionsArgument));
    } else {
      return originalFetch.apply(window, [input, optionsArgument]);
    }

    effectiveOptions.method = effectiveOptions.method || 'GET';
    if (!effectiveOptions.headers) {
      effectiveOptions.headers = new Headers();
    }


    if (typeof actualUrl === 'string' && googleLlmBaseApiUrls.some((url) => actualUrl.startsWith(url))) {
      let apiKeyIsNull = true;

      const regex = new RegExp("models/([^:]+)");
      const modelNameMatch = actualUrl.match(regex);
      const modelName = modelNameMatch ? modelNameMatch[1] : 'unspecified';


      try {
        const urlObject = new URL(actualUrl);  // Use URL object for robust parsing
        const apiKeyParam = urlObject.searchParams.get('key');
        if (apiKeyParam) {
          apiKeyIsNull = false;
        }
      } catch (e) {
        // Continue checks even if URL parsing fails
      }

      if (apiKeyIsNull && effectiveOptions.headers) {
        const h = new Headers(effectiveOptions.headers);
        const apiKeyHeaderValue = h.get('X-API-Key') || h.get('x-api-key');
        if (apiKeyHeaderValue) {
          apiKeyIsNull = false;
          return originalFetch.apply(window, fetchCallArgs);
        }
      }

      if (apiKeyIsNull && effectiveOptions.method && ['POST', 'PUT', 'PATCH'].includes(effectiveOptions.method.toUpperCase()) && typeof bodyForApiKeyCheck === 'string') {
        try {
          const bodyData = JSON.parse(bodyForApiKeyCheck);
          if (bodyData && bodyData.apiKey) {
            apiKeyIsNull = false;
            return originalFetch.apply(window, fetchCallArgs);
          }
        } catch (e) {
          // Ignore JSON parsing errors
        }
      }

      if(apiKeyIsNull) {
        const promiseId = nextPromiseId++;
        const promise = new Promise((resolve) => {
          pendingFetchResolvers[promiseId] = (resolvedResponse) => {
            delete pendingFetchResolvers[promiseId];
            resolve(resolvedResponse);
          };
        });

        let serializedBodyForPostMessage;
        if (typeof bodyForPostMessage === 'string' || bodyForPostMessage == null) {
            serializedBodyForPostMessage = bodyForPostMessage;
        } else if (bodyForPostMessage instanceof ReadableStream) {
            serializedBodyForPostMessage = null;
        } else {
            try {
                serializedBodyForPostMessage = JSON.stringify(bodyForPostMessage);
            } catch (e) {
                serializedBodyForPostMessage = null;
            }
        }

        const messageOptions = {
            method: effectiveOptions.method,
            headers: Object.fromEntries(new Headers(effectiveOptions.headers).entries()),
            body: serializedBodyForPostMessage
        };

        window.parent.postMessage({
          type: 'requestFetch',
          url: actualUrl,
          modelName: modelName,
          options: messageOptions,
          promiseId: promiseId,
        }, '*');

        return promise;
      }
      return originalFetch.apply(window, fetchCallArgs);
    }
    return originalFetch.apply(window, fetchCallArgs);
  };

  window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'resolveFetch') {
      const { promiseId, response } = event.data;
      if (pendingFetchResolvers[promiseId]) {
        try {
          const reconstructedResponse = new Response(response.body, {
            status: response.status,
            statusText: response.statusText,
            headers: new Headers(response.headers),
          });
          pendingFetchResolvers[promiseId](reconstructedResponse);
        } catch (error) {
          pendingFetchResolvers[promiseId](new Response(null, { status: 500, statusText: "Interceptor Response Reconstruction Error" }));
        }
      }
    }
  });

}))({"textModelName":"gemini-2.5-flash-preview-09-2025","imageModelName":"imagen-4.0-generate-001","imageEditModelName":"gemini-2.5-flash-image-preview","imageTransformModelName":"gemini-3-pro-image-preview-11-2025","videoModelName":"veo-2.0-generate-001","ttsModelName":"gemini-2.5-flash-preview-tts","deprecatedTextModelNames":["gemini-2.0-flash","gemini-2.5-flash-preview-04-17","gemini-2.5-flash-preview-05-20"],"deprecatedImageModelNames":["imagen-3.0-generate-001","imagen-3.0-generate-002"]})</script><script>(function() {
  const originalConsoleLog = console.log;
  const originalConsoleError = console.error;

    /**
   * Normalizes an error event or a promise rejection reason into a structured error object.
   * @param {*} errorEventOrReason The error object or reason.
   * @return {object} Structured error data { message, name, stack }.
   */
  function getErrorObject(errorEventOrReason) {
    if (errorEventOrReason instanceof Error) {
      return {
        message: errorEventOrReason.message,
        name: errorEventOrReason.name,
        stack: errorEventOrReason.stack,
      };
    }
    // Fallback for non-Error objects.
    try {
      return {
        message: JSON.stringify(errorEventOrReason),
        name: 'UnknownErrorType',
        stack: null,
      };
    } catch (e) {
      return {
        message: String(errorEventOrReason),
        name: 'UnknownErrorTypeNonStringifiable',
        stack: null,
      };
    }
  }

  /**
   * Converts an array of arguments (from log/error) into a single string.
   * Handles Error objects specially to include their message and stack.
   * @param {Array<*>} args - Arguments passed to console methods.
   * @return {string} A string representation of the arguments.
   */
  function stringifyArgs(args) {
    return args
      .map((arg) => {
        if (arg instanceof Error) {
          const {message, stack} = arg;
          return `Error: ${message}${stack ? ('\nStack: ' + stack) : ''}`;
        }
        if (typeof arg === 'object' && arg !== null) {
          try {
            return JSON.stringify(arg);
          } catch (error) {
            return '[Circular Object]';
          }
        } else {
          return String(arg);
        }
      })
      .join(' ');
  }

  console.log = function(...args) {
    const logString = stringifyArgs(args);
    window.parent.postMessage({ type: 'log', message: logString }, '*');
    originalConsoleLog.apply(console, args);
  };

  console.error = function(...args) {
    let errorData;
    if (args.length > 0 && args[0] instanceof Error) {
      const err = args[0];
      // If the first arg is an Error, capture its details.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        ...getErrorObject(err),
        rawArgsString: stringifyArgs(args.slice(1)),
        timestamp: new Date().toISOString(),
      };
    } else {
      // If not an Error object, treat all args as a general error message.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        message: stringifyArgs(args),
        name: 'ConsoleLoggedError',
        stack: null,
        timestamp: new Date().toISOString(),
      };
    }
    window.parent.postMessage(errorData, '*');
    originalConsoleError.apply(console, args);
  };

  // Listen for global unhandled synchronous errors.
  window.addEventListener('error', function(event) {
    const errorDetails = event.error ? getErrorObject(event.error) : {
      message: event.message,
      name: 'GlobalError',
      stack: null,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
    };

    window.parent.postMessage({
      type: 'error',
      source: 'global',
      ...errorDetails,
      message: errorDetails.message || event.message,
      timestamp: new Date().toISOString(),
    }, '*');
  });

  // Listen for unhandled promise rejections (asynchronous errors).
  window.addEventListener('unhandledrejection', function(event) {
    const errorDetails = getErrorObject(event.reason);

    window.parent.postMessage({
      type: 'error',
      source: 'unhandledrejection',
      ...errorDetails,
      message: errorDetails.message || 'Unhandled Promise Rejection',
      timestamp: new Date().toISOString(),
    }, '*');
  });

})();</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ffffff">
    <title>Link Pocket - みんなのメモ帳</title>
    
    <!-- App Icon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='32' fill='%2310b981'/%3E%3Cpath d='M32 36h64v28a32 32 0 0 1-64 0z' fill='none' stroke='white' stroke-width='12' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpolyline points='48 60 64 76 80 60' fill='none' stroke='white' stroke-width='12' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&amp;family=Nunito:wght@600;700;800&amp;display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"M PLUS Rounded 1c"', '"Nunito"', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669',
                        },
                        surface: '#f8fafc',
                        background: '#f1f5f9',
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'float': '0 10px 30px -5px rgba(16, 185, 129, 0.25)',
                        'card': '0 4px 12px -2px rgba(0, 0, 0, 0.08), 0 2px 6px -2px rgba(0,0,0,0.04)',
                        'fab': '0 4px 20px rgba(16, 185, 129, 0.4)',
                    },
                    animation: {
                        'pop-in': 'popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'bounce-sm': 'bounceSm 0.5s cubic-bezier(0.36, 0, 0.66, -0.56) 1 alternate',
                        'vibrate': 'vibrate 0.3s linear both',
                    },
                    keyframes: {
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95) translateY(10px)' },
                            '100%': { opacity: '1', transform: 'scale(1) translateY(0)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        bounceSm: {
                            '0%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.2)' },
                            '100%': { transform: 'scale(1)' }
                        },
                        vibrate: {
                            '0%, 100%': { transform: 'translateX(0)' },
                            '20%': { transform: 'translateX(-4px)' },
                            '40%': { transform: 'translateX(4px)' },
                            '60%': { transform: 'translateX(-4px)' },
                            '80%': { transform: 'translateX(4px)' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest" crossorigin="anonymous"></script>

    <style>
        body {
            background-color: #f1f5f9; /* Slate-100 */
            -webkit-font-smoothing: antialiased;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
            touch-action: manipulation; 
            overscroll-behavior-y: auto;
        }

        /* Mobile Optimization */
        input, textarea, button, select {
            font-size: 16px !important;
            touch-action: manipulation;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Improved Category Radio Logic */
        .category-wrapper {
            position: relative;
            display: inline-block;
        }
        .category-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }
        
        .category-input:checked + label {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
            transform: scale(1.05);
        }
        
        .category-error label {
            border-color: #fca5a5;
            background-color: #fef2f2;
            color: #ef4444;
        }

        /* Color Picker Styling */
        .color-radio:checked + label {
            transform: scale(1.2);
            box-shadow: 0 0 0 2px white, 0 0 0 4px currentColor;
        }
        
        .custom-color-wrapper input[type="color"] {
            opacity: 0;
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Modal Transitions */
        .modal-enter { opacity: 0; pointer-events: none; }
        .modal-enter .modal-content { transform: translateY(100%) scale(0.95); }
        .modal-active { opacity: 1; pointer-events: auto; }
        .modal-active .modal-content { transform: translateY(0) scale(1); }
        
        /* Full Screen Modal Transitions */
        .full-modal-enter { transform: translateY(100%); }
        .full-modal-active { transform: translateY(0); }

        /* Highlight Animation */
        .highlight-card {
            animation: highlightPulse 2s ease-out forwards;
        }
        @keyframes highlightPulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); border-color: #10b981; }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); border-color: #10b981; }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        /* Force clickable buttons - Critical for event delegation targets */
        .card-action-btn {
            position: relative;
            z-index: 50 !important;
            cursor: pointer;
            pointer-events: auto !important;
            touch-action: manipulation;
        }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:"M PLUS Rounded 1c", "Nunito", sans-serif;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.pointer-events-none{pointer-events:none}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.sticky{position:sticky}.inset-0{inset:0px}.inset-y-0{top:0px;bottom:0px}.left-0{left:0px}.right-0{right:0px}.top-0{top:0px}.bottom-2{bottom:0.5rem}.bottom-6{bottom:1.5rem}.left-1\/2{left:50%}.right-1{right:0.25rem}.right-3{right:0.75rem}.right-4{right:1rem}.right-6{right:1.5rem}.top-1{top:0.25rem}.top-6{top:1.5rem}.z-40{z-index:40}.z-10{z-index:10}.z-50{z-index:50}.z-\[60\]{z-index:60}.z-\[70\]{z-index:70}.mx-auto{margin-left:auto;margin-right:auto}.-mx-4{margin-left:-1rem;margin-right:-1rem}.mx-2{margin-left:0.5rem;margin-right:0.5rem}.-mr-2{margin-right:-0.5rem}.-mr-3{margin-right:-0.75rem}.mb-0\.5{margin-bottom:0.125rem}.mb-1{margin-bottom:0.25rem}.mb-1\.5{margin-bottom:0.375rem}.mb-2{margin-bottom:0.5rem}.mb-4{margin-bottom:1rem}.ml-1{margin-left:0.25rem}.mr-1{margin-right:0.25rem}.mt-1{margin-top:0.25rem}.mt-2{margin-top:0.5rem}.mt-4{margin-top:1rem}.block{display:block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-4{height:1rem}.h-8{height:2rem}.h-10{height:2.5rem}.h-12{height:3rem}.h-14{height:3.5rem}.h-20{height:5rem}.h-3{height:0.75rem}.h-3\.5{height:0.875rem}.h-5{height:1.25rem}.h-6{height:1.5rem}.h-7{height:1.75rem}.h-9{height:2.25rem}.h-\[46px\]{height:46px}.h-\[80dvh\]{height:80dvh}.h-\[85dvh\]{height:85dvh}.h-full{height:100%}.max-h-32{max-height:8rem}.max-h-\[90dvh\]{max-height:90dvh}.min-h-screen{min-height:100vh}.w-4{width:1rem}.w-8{width:2rem}.w-12{width:3rem}.w-14{width:3.5rem}.w-20{width:5rem}.w-3{width:0.75rem}.w-3\.5{width:0.875rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-7{width:1.75rem}.w-9{width:2.25rem}.w-full{width:100%}.w-10{width:2.5rem}.min-w-\[40px\]{min-width:40px}.min-w-\[46px\]{min-width:46px}.min-w-\[32px\]{min-width:32px}.max-w-3xl{max-width:48rem}.max-w-\[240px\]{max-width:240px}.max-w-\[80px\]{max-width:80px}.max-w-lg{max-width:32rem}.flex-shrink-0{flex-shrink:0}.flex-grow{flex-grow:1}.origin-right{transform-origin:right}.-translate-x-1\/2{--tw-translate-x:-50%;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.-translate-y-48{--tw-translate-y:-12rem;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.translate-y-full{--tw-translate-y:100%;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.rotate-12{--tw-rotate:12deg;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.scale-0{--tw-scale-x:0;--tw-scale-y:0;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.scale-90{--tw-scale-x:.9;--tw-scale-y:.9;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.scale-95{--tw-scale-x:.95;--tw-scale-y:.95;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}.animate-fade-in{animation:fadeIn 0.2s ease-out forwards}.cursor-pointer{cursor:pointer}.cursor-default{cursor:default}.select-none{-webkit-user-select:none;user-select:none}.select-all{-webkit-user-select:all;user-select:all}.resize-none{resize:none}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.gap-1\.5{gap:0.375rem}.gap-3{gap:0.75rem}.gap-4{gap:1rem}.gap-5{gap:1.25rem}.space-y-1\.5 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.375rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.375rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-5 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.25rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.25rem * var(--tw-space-y-reverse))}.space-y-6 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem * var(--tw-space-y-reverse))}.space-y-8 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(2rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(2rem * var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.overscroll-contain{overscroll-behavior:contain}.overscroll-y-auto{overscroll-behavior-y:auto}.scroll-smooth{scroll-behavior:smooth}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.whitespace-nowrap{white-space:nowrap}.rounded-xl{border-radius:0.75rem}.rounded-2xl{border-radius:1rem}.rounded-3xl{border-radius:1.5rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:0.5rem}.rounded-t-\[32px\]{border-top-left-radius:32px;border-top-right-radius:32px}.border{border-width:1px}.border-2{border-width:2px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-b-2{border-bottom-width:2px}.border-slate-100{--tw-border-opacity:1;border-color:rgb(241 245 249 / var(--tw-border-opacity, 1))}.border-blue-100{--tw-border-opacity:1;border-color:rgb(219 234 254 / var(--tw-border-opacity, 1))}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254 / var(--tw-border-opacity, 1))}.border-slate-200{--tw-border-opacity:1;border-color:rgb(226 232 240 / var(--tw-border-opacity, 1))}.border-slate-700\/50{border-color:rgb(51 65 85 / 0.5)}.border-transparent{border-color:transparent}.border-emerald-500{--tw-border-opacity:1;border-color:rgb(16 185 129 / var(--tw-border-opacity, 1))}.bg-slate-100{--tw-bg-opacity:1;background-color:rgb(241 245 249 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255 / var(--tw-bg-opacity, 1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246 / var(--tw-bg-opacity, 1))}.bg-emerald-50{--tw-bg-opacity:1;background-color:rgb(236 253 245 / var(--tw-bg-opacity, 1))}.bg-emerald-500{--tw-bg-opacity:1;background-color:rgb(16 185 129 / var(--tw-bg-opacity, 1))}.bg-red-500{--tw-bg-opacity:1;background-color:rgb(239 68 68 / var(--tw-bg-opacity, 1))}.bg-slate-100\/80{background-color:rgb(241 245 249 / 0.8)}.bg-slate-400{--tw-bg-opacity:1;background-color:rgb(148 163 184 / var(--tw-bg-opacity, 1))}.bg-slate-50{--tw-bg-opacity:1;background-color:rgb(248 250 252 / var(--tw-bg-opacity, 1))}.bg-slate-50\/80{background-color:rgb(248 250 252 / 0.8)}.bg-slate-800{--tw-bg-opacity:1;background-color:rgb(30 41 59 / var(--tw-bg-opacity, 1))}.bg-slate-800\/90{background-color:rgb(30 41 59 / 0.9)}.bg-slate-900\/30{background-color:rgb(15 23 42 / 0.3)}.bg-slate-900\/40{background-color:rgb(15 23 42 / 0.4)}.bg-white\/80{background-color:rgb(255 255 255 / 0.8)}.bg-gradient-to-br{background-image:linear-gradient(to bottom right, var(--tw-gradient-stops))}.bg-gradient-to-l{background-image:linear-gradient(to left, var(--tw-gradient-stops))}.from-emerald-400{--tw-gradient-from:#34d399 var(--tw-gradient-from-position);--tw-gradient-to:rgb(52 211 153 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-white{--tw-gradient-from:#fff var(--tw-gradient-from-position);--tw-gradient-to:rgb(255 255 255 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-pink-500{--tw-gradient-from:#ec4899 var(--tw-gradient-from-position);--tw-gradient-to:rgb(236 72 153 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.via-purple-500{--tw-gradient-to:rgb(168 85 247 / 0)  var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), #a855f7 var(--tw-gradient-via-position), var(--tw-gradient-to)}.to-green-600{--tw-gradient-to:#16a34a var(--tw-gradient-to-position)}.to-transparent{--tw-gradient-to:transparent var(--tw-gradient-to-position)}.to-indigo-500{--tw-gradient-to:#6366f1 var(--tw-gradient-to-position)}.stroke-\[3\]{stroke-width:3}.p-0{padding:0px}.p-2{padding:0.5rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.px-4{padding-left:1rem;padding-right:1rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-5{padding-left:1.25rem;padding-right:1.25rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-20{padding-top:5rem;padding-bottom:5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.px-1\.5{padding-left:0.375rem;padding-right:0.375rem}.px-2\.5{padding-left:0.625rem;padding-right:0.625rem}.pb-32{padding-bottom:8rem}.pb-10{padding-bottom:2.5rem}.pb-2{padding-bottom:0.5rem}.pb-20{padding-bottom:5rem}.pb-6{padding-bottom:1.5rem}.pb-8{padding-bottom:2rem}.pl-10{padding-left:2.5rem}.pl-3\.5{padding-left:0.875rem}.pl-4{padding-left:1rem}.pr-14{padding-right:3.5rem}.pr-4{padding-right:1rem}.pt-2{padding-top:0.5rem}.pt-32{padding-top:8rem}.pt-6{padding-top:1.5rem}.pt-8{padding-top:2rem}.text-center{text-align:center}.font-mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}.text-\[10px\]{font-size:10px}.text-\[9px\]{font-size:9px}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xs{font-size:0.75rem;line-height:1rem}.text-\[8px\]{font-size:8px}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-normal{font-weight:400}.leading-none{line-height:1}.tracking-tight{letter-spacing:-0.025em}.tracking-wide{letter-spacing:0.025em}.text-slate-600{--tw-text-opacity:1;color:rgb(71 85 105 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-blue-400{--tw-text-opacity:1;color:rgb(96 165 250 / var(--tw-text-opacity, 1))}.text-emerald-300{--tw-text-opacity:1;color:rgb(110 231 183 / var(--tw-text-opacity, 1))}.text-emerald-400{--tw-text-opacity:1;color:rgb(52 211 153 / var(--tw-text-opacity, 1))}.text-emerald-500{--tw-text-opacity:1;color:rgb(16 185 129 / var(--tw-text-opacity, 1))}.text-red-400{--tw-text-opacity:1;color:rgb(248 113 113 / var(--tw-text-opacity, 1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68 / var(--tw-text-opacity, 1))}.text-slate-300{--tw-text-opacity:1;color:rgb(203 213 225 / var(--tw-text-opacity, 1))}.text-slate-400{--tw-text-opacity:1;color:rgb(148 163 184 / var(--tw-text-opacity, 1))}.text-slate-500{--tw-text-opacity:1;color:rgb(100 116 139 / var(--tw-text-opacity, 1))}.text-slate-700{--tw-text-opacity:1;color:rgb(51 65 85 / var(--tw-text-opacity, 1))}.text-slate-800{--tw-text-opacity:1;color:rgb(30 41 59 / var(--tw-text-opacity, 1))}.text-emerald-600{--tw-text-opacity:1;color:rgb(5 150 105 / var(--tw-text-opacity, 1))}.opacity-0{opacity:0}.opacity-80{opacity:0.8}.shadow-\[0_4px_20px_-12px_rgba\(0\2c 0\2c 0\2c 0\.05\)\]{--tw-shadow:0 4px 20px -12px rgba(0,0,0,0.05);--tw-shadow-colored:0 4px 20px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-fab{--tw-shadow:0 4px 20px rgba(16, 185, 129, 0.4);--tw-shadow-colored:0 4px 20px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-none{--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-emerald-500\/20{--tw-shadow-color:rgb(16 185 129 / 0.2);--tw-shadow:var(--tw-shadow-colored)}.shadow-emerald-500\/30{--tw-shadow-color:rgb(16 185 129 / 0.3);--tw-shadow:var(--tw-shadow-colored)}.backdrop-blur{--tw-backdrop-blur:blur(8px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.backdrop-blur-md{--tw-backdrop-blur:blur(12px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.backdrop-blur-sm{--tw-backdrop-blur:blur(4px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.duration-500{transition-duration:500ms}.placeholder\:font-medium::placeholder{font-weight:500}.placeholder\:text-slate-300::placeholder{--tw-text-opacity:1;color:rgb(203 213 225 / var(--tw-text-opacity, 1))}.hover\:scale-110:hover{--tw-scale-x:1.1;--tw-scale-y:1.1;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:border-slate-200:hover{--tw-border-opacity:1;border-color:rgb(226 232 240 / var(--tw-border-opacity, 1))}.hover\:bg-blue-600:hover{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.hover\:bg-emerald-600:hover{--tw-bg-opacity:1;background-color:rgb(5 150 105 / var(--tw-bg-opacity, 1))}.hover\:bg-slate-100:hover{--tw-bg-opacity:1;background-color:rgb(241 245 249 / var(--tw-bg-opacity, 1))}.hover\:bg-slate-200:hover{--tw-bg-opacity:1;background-color:rgb(226 232 240 / var(--tw-bg-opacity, 1))}.hover\:bg-slate-50:hover{--tw-bg-opacity:1;background-color:rgb(248 250 252 / var(--tw-bg-opacity, 1))}.hover\:bg-white:hover{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.hover\:text-slate-600:hover{--tw-text-opacity:1;color:rgb(71 85 105 / var(--tw-text-opacity, 1))}.hover\:text-slate-700:hover{--tw-text-opacity:1;color:rgb(51 65 85 / var(--tw-text-opacity, 1))}.hover\:shadow-sm:hover{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.focus\:border-blue-400:focus{--tw-border-opacity:1;border-color:rgb(96 165 250 / var(--tw-border-opacity, 1))}.focus\:border-emerald-400:focus{--tw-border-opacity:1;border-color:rgb(52 211 153 / var(--tw-border-opacity, 1))}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring-4:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(4px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.focus\:ring-emerald-100:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(209 250 229 / var(--tw-ring-opacity, 1))}.active\:scale-95:active{--tw-scale-x:.95;--tw-scale-y:.95;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.active\:scale-\[0\.98\]:active{--tw-scale-x:0.98;--tw-scale-y:0.98;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.active\:bg-slate-100:active{--tw-bg-opacity:1;background-color:rgb(241 245 249 / var(--tw-bg-opacity, 1))}.active\:bg-slate-100\/50:active{background-color:rgb(241 245 249 / 0.5)}.disabled\:opacity-50:disabled{opacity:0.5}.group:hover .group-hover\:rotate-6{--tw-rotate:6deg;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.group:hover .group-hover\:rotate-90{--tw-rotate:90deg;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}@media (min-width: 640px){.sm\:m-4{margin:1rem}.sm\:h-\[80vh\]{height:80vh}.sm\:h-\[calc\(100vh-2rem\)\]{height:calc(100vh - 2rem)}.sm\:w-96{width:24rem}.sm\:items-start{align-items:flex-start}.sm\:items-center{align-items:center}.sm\:rounded-2xl{border-radius:1rem}.sm\:rounded-\[32px\]{border-radius:32px}.sm\:pb-0{padding-bottom:0px}.sm\:pb-4{padding-bottom:1rem}}@media (min-width: 768px){.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}}</style></head>
<body class="text-slate-600 min-h-screen pb-32 bg-slate-100 overscroll-y-auto">

    <!-- Splash Screen -->
    <!-- Inline styles to ensure visibility before CSS loads, SVG inlined for instant render -->
    

    <!-- Header Wrapper (Sticky / Hide on Scroll) -->
    <header id="app-header-wrapper" class="fixed top-0 left-0 right-0 z-40 bg-white border-b border-slate-100 transition-transform duration-300 shadow-[0_4px_20px_-12px_rgba(0,0,0,0.05)]">
        
        <!-- Navbar -->
        <div class="max-w-3xl mx-auto px-4 py-4 flex items-center justify-between">
            <!-- Title (Reload Trigger) -->
            <div class="flex items-center gap-2 select-none cursor-pointer group active:scale-95 transition-transform flex-shrink-0" id="app-header-title" title="リロード">
                <div class="w-8 h-8 bg-gradient-to-br from-emerald-400 to-green-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/20 transform group-hover:rotate-6 transition-transform duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="pocket" class="lucide lucide-pocket w-4 h-4"><path d="M20 3a2 2 0 0 1 2 2v6a1 1 0 0 1-20 0V5a2 2 0 0 1 2-2z"></path><path d="m8 10 4 4 4-4"></path></svg>
                </div>
                <div>
                    <h1 class="text-base font-bold text-slate-800 leading-none tracking-tight">Link Pocket</h1>
                </div>
            </div>

            <!-- Secret Download Area (Spacer) -->
            <div id="header-spacer" class="flex-grow mx-2 min-w-[40px] h-10 cursor-default active:bg-slate-100/50 rounded-lg transition-colors" title="トリプルクリックで保存"></div>
            
            <div class="flex items-center gap-3 flex-shrink-0">
                <!-- Recent Comments Icon -->
                <button id="btn-recent-comments" class="relative p-2 rounded-full hover:bg-slate-100 transition-colors z-50" onclick="openRecentCommentsModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="message-square" class="lucide lucide-message-square w-5 h-5 text-slate-500"><path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"></path></svg>
                    <!-- Notification Badge -->
                    <div id="badge-comments" class="absolute top-1 right-1 w-3.5 h-3.5 bg-red-500 text-white text-[9px] font-bold rounded-full flex items-center justify-center shadow-sm opacity-0 transform scale-0 transition-all duration-300 pointer-events-none">0</div>
                </button>

                <!-- User Icon (Clickable for settings) -->
                <button id="btn-profile-settings" class="flex items-center gap-2 px-2 py-1 bg-slate-100 hover:bg-slate-50 border border-transparent hover:border-slate-200 rounded-full transition-all active:scale-95 z-50" onclick="openProfileModal()">
                    <div id="current-user-avatar" class="w-5 h-5 rounded-full bg-slate-400 flex items-center justify-center text-white text-[9px] font-bold transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="user" class="lucide lucide-user w-3 h-3"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </div>
                    <span class="text-[10px] font-bold text-slate-500 max-w-[80px] truncate" id="current-user-name">ゲスト</span>
                </button>
            </div>
        </div>

        <!-- Category Filter (Inside Header Wrapper) -->
        <div class="w-full bg-white pb-2 relative">
            <div class="max-w-3xl mx-auto pl-4 pr-14 overflow-x-auto no-scrollbar flex items-center gap-2 scroll-smooth" id="filter-container"><button class="category-filter-btn active flex-shrink-0 px-2 py-1 text-[8px] font-bold text-emerald-600 border-b-2 border-emerald-500 transition-all cursor-pointer min-w-[32px] whitespace-nowrap" data-cat="all">すべて</button><button class="flex-shrink-0 px-1.5 py-1 text-[8px] font-bold text-slate-400 border-b-2 border-transparent hover:text-slate-600 transition-all cursor-pointer min-w-[32px] whitespace-nowrap" data-cat="グルメ">グルメ</button><button class="flex-shrink-0 px-1.5 py-1 text-[8px] font-bold text-slate-400 border-b-2 border-transparent hover:text-slate-600 transition-all cursor-pointer min-w-[32px] whitespace-nowrap" data-cat="ビジネス">ビジネス</button><button class="flex-shrink-0 px-1.5 py-1 text-[8px] font-bold text-slate-400 border-b-2 border-transparent hover:text-slate-600 transition-all cursor-pointer min-w-[32px] whitespace-nowrap" data-cat="エンタメ">エンタメ</button><button class="flex-shrink-0 px-1.5 py-1 text-[8px] font-bold text-slate-400 border-b-2 border-transparent hover:text-slate-600 transition-all cursor-pointer min-w-[32px] whitespace-nowrap" data-cat="小ネタ">小ネタ</button><button class="flex-shrink-0 px-1.5 py-1 text-[8px] font-bold text-slate-400 border-b-2 border-transparent hover:text-slate-600 transition-all cursor-pointer min-w-[32px] whitespace-nowrap" data-cat="その他">その他</button></div>
            <!-- Right Fade Overlay -->
            <div class="absolute inset-y-0 right-0 w-12 bg-gradient-to-l from-white to-transparent pointer-events-none"></div>
        </div>
    </header>

    <!-- Main Content -->
    <!-- Added top padding to compensate fixed header -->
    <main class="max-w-3xl mx-auto px-4 pt-32 space-y-6">
        
        <!-- Cards List -->
        <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-5 pb-20"></div>

        <!-- Empty State -->
        <div id="empty-state" class="flex flex-col items-center justify-center py-20 text-center opacity-0 animate-fade-in">
            <div class="w-20 h-20 bg-emerald-50 text-emerald-300 rounded-full flex items-center justify-center mb-4 transform rotate-12">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="ghost" class="lucide lucide-ghost w-9 h-9"><path d="M9 10h.01"></path><path d="M15 10h.01"></path><path d="M12 2a8 8 0 0 0-8 8v12l3-3 2.5 2.5L12 19l2.5 2.5L17 19l3 3V10a8 8 0 0 0-8-8z"></path></svg>
            </div>
            <h3 class="text-slate-800 font-bold text-lg">まだ投稿がありません</h3>
            <p class="text-slate-400 text-sm mt-1">右下のボタンからメモを追加しよう！</p>
        </div>

    </main>

    <!-- Floating Action Button (FAB) -->
    <button id="btn-fab" class="fixed bottom-6 right-6 w-14 h-14 bg-emerald-500 hover:bg-emerald-600 text-white rounded-full shadow-fab flex items-center justify-center transform transition-all duration-300 hover:scale-110 active:scale-95 z-40 group cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="plus" class="lucide lucide-plus w-7 h-7 stroke-[3] group-hover:rotate-90 transition-transform duration-300"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
    </button>

    <!-- Post Modal (New/Edit Memo) -->
    <div id="post-modal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center modal-enter transition-all duration-300">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity duration-300" onclick="closePostModal()"></div>
        <div class="modal-content relative w-full max-w-lg bg-white sm:rounded-[32px] rounded-t-[32px] shadow-2xl overflow-hidden flex flex-col max-h-[90dvh] transition-transform duration-300">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-100 bg-white/80 backdrop-blur-md sticky top-0 z-10">
                <h3 class="font-bold text-lg text-slate-800" id="modal-title">メモを追加</h3>
                <button onclick="closePostModal()" class="p-2 -mr-3 bg-slate-100/80 hover:bg-slate-200 text-slate-500 hover:text-slate-700 rounded-full transition-colors cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="x" class="lucide lucide-x w-5 h-5"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                </button>
            </div>

            <!-- Form -->
            <div class="p-6 overflow-y-auto overscroll-contain">
                <div class="space-y-5">
                    <!-- URL + Auto Fetch -->
                    <div class="space-y-1.5">
                        <label for="inp-url" class="block text-xs font-bold text-slate-400 ml-1 cursor-pointer">URL <span class="text-[10px] font-normal text-slate-400">(任意)</span></label>
                        <div class="flex gap-2">
                            <div class="relative flex-grow">
                                <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none text-emerald-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="link" class="lucide lucide-link w-5 h-5"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                                </div>
                                <input type="url" id="inp-url" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl py-2 pl-10 pr-4 font-bold text-slate-700 placeholder:text-slate-300 placeholder:font-medium focus:outline-none focus:border-emerald-400 focus:ring-4 focus:ring-emerald-100 transition-all text-sm" placeholder="https://..." autocomplete="off">
                            </div>
                            <button id="btn-auto-fetch" class="flex-shrink-0 px-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-2xl font-bold text-xs flex items-center justify-center gap-1.5 transition-colors active:scale-95 disabled:opacity-50 w-12 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="wand-2" class="lucide lucide-wand-2 w-5 h-5"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72"></path><path d="m14 7 3 3"></path><path d="M5 6v4"></path><path d="M19 14v4"></path><path d="M10 2v2"></path><path d="M7 8H3"></path><path d="M21 16h-4"></path><path d="M11 3H9"></path></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Title -->
                    <div>
                        <label for="inp-title" class="block text-xs font-bold text-slate-400 mb-1.5 ml-1 cursor-pointer">タイトル <span class="text-red-400">*</span></label>
                        <input type="text" id="inp-title" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-2 font-bold text-slate-700 placeholder:text-slate-300 placeholder:font-medium focus:outline-none focus:border-emerald-400 focus:ring-4 focus:ring-emerald-100 transition-all" placeholder="記事のタイトル">
                    </div>

                    <!-- Memo -->
                    <div class="space-y-4">
                        <div class="relative">
                            <label for="inp-memo" class="block text-xs font-bold text-slate-400 mb-1.5 ml-1 cursor-pointer">ひとことメモ <span class="text-[10px] font-normal text-slate-400">(最大100文字)</span></label>
                            <textarea id="inp-memo" rows="3" maxlength="100" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3 font-medium text-slate-700 placeholder:text-slate-300 focus:outline-none focus:border-emerald-400 focus:ring-4 focus:ring-emerald-100 transition-all resize-none" placeholder="感想やポイントを書いてね"></textarea>
                            <div class="absolute bottom-2 right-3 text-[10px] font-bold text-slate-300 pointer-events-none">
                                <span id="memo-counter">0</span>/100
                            </div>
                        </div>
                    </div>

                    <!-- Category -->
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2 ml-1">カテゴリ <span class="text-red-400">*</span></label>
                        <div class="flex flex-wrap gap-2" id="category-selector">
                <div class="category-wrapper">
                    <input type="radio" name="category" id="cat-0" value="グルメ" class="category-input">
                    <label for="cat-0" class="block px-2.5 py-1 rounded-xl text-[10px] font-bold bg-slate-100 text-slate-500 border border-slate-200 transition-all hover:bg-white hover:shadow-sm select-none">
                        グルメ
                    </label>
                </div>
            
                <div class="category-wrapper">
                    <input type="radio" name="category" id="cat-1" value="ビジネス" class="category-input">
                    <label for="cat-1" class="block px-2.5 py-1 rounded-xl text-[10px] font-bold bg-slate-100 text-slate-500 border border-slate-200 transition-all hover:bg-white hover:shadow-sm select-none">
                        ビジネス
                    </label>
                </div>
            
                <div class="category-wrapper">
                    <input type="radio" name="category" id="cat-2" value="エンタメ" class="category-input">
                    <label for="cat-2" class="block px-2.5 py-1 rounded-xl text-[10px] font-bold bg-slate-100 text-slate-500 border border-slate-200 transition-all hover:bg-white hover:shadow-sm select-none">
                        エンタメ
                    </label>
                </div>
            
                <div class="category-wrapper">
                    <input type="radio" name="category" id="cat-3" value="小ネタ" class="category-input">
                    <label for="cat-3" class="block px-2.5 py-1 rounded-xl text-[10px] font-bold bg-slate-100 text-slate-500 border border-slate-200 transition-all hover:bg-white hover:shadow-sm select-none">
                        小ネタ
                    </label>
                </div>
            
                <div class="category-wrapper">
                    <input type="radio" name="category" id="cat-4" value="その他" class="category-input">
                    <label for="cat-4" class="block px-2.5 py-1 rounded-xl text-[10px] font-bold bg-slate-100 text-slate-500 border border-slate-200 transition-all hover:bg-white hover:shadow-sm select-none">
                        その他
                    </label>
                </div>
            </div>
                        <p id="category-error-msg" class="hidden text-[10px] text-red-500 font-bold mt-1 ml-1">カテゴリを選択してください</p>
                    </div>

                    <!-- Submit -->
                    <div class="pt-2 pb-6 sm:pb-0">
                        <button id="btn-save" class="w-full py-4 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-2xl shadow-lg shadow-emerald-500/30 transition-all flex items-center justify-center gap-2 group active:scale-[0.98] cursor-pointer">
                            <span>保存する</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="send" class="lucide lucide-send w-4 h-4 ml-1"><path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"></path><path d="m21.854 2.147-10.94 10.939"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Settings Modal (Full Screen) -->
    <div id="profile-modal" class="fixed inset-0 z-[60] bg-white transition-transform duration-300 translate-y-full flex flex-col">
        <!-- Header -->
        <div class="px-4 py-4 border-b border-slate-100 flex items-center justify-center bg-white flex-shrink-0 relative">
            <h3 class="font-bold text-lg text-slate-800">プロフィール設定</h3>
            <button onclick="closeProfileModal()" class="absolute right-4 p-2 -mr-2 bg-slate-100/80 hover:bg-slate-200 text-slate-500 hover:text-slate-700 rounded-full transition-colors cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="x" class="lucide lucide-x w-5 h-5"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
            </button>
        </div>
        
        <div class="flex-grow overflow-y-auto overscroll-contain p-6 pb-20">
            <div class="space-y-8 max-w-lg mx-auto">
                <!-- Nickname Input -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 ml-1 text-center">ニックネーム</label>
                    <input type="text" id="inp-profile-nickname" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-4 font-bold text-lg text-slate-700 text-center focus:outline-none focus:border-emerald-400 focus:ring-4 focus:ring-emerald-100 transition-all" placeholder="名前を入力">
                </div>

                <!-- Color Picker -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-4 ml-1 text-center">テーマカラー</label>
                    <div class="flex flex-wrap justify-center gap-4" id="color-picker-container">
                <div class="relative">
                    <input type="radio" name="color" id="col-0" value="#94a3b8" class="peer hidden color-radio">
                    <label for="col-0" class="block w-10 h-10 rounded-full cursor-pointer transition-transform hover:scale-110 shadow-sm border border-slate-200" style="background-color: #94a3b8"></label>
                </div>
            
                <div class="relative">
                    <input type="radio" name="color" id="col-1" value="#ef4444" class="peer hidden color-radio">
                    <label for="col-1" class="block w-10 h-10 rounded-full cursor-pointer transition-transform hover:scale-110 shadow-sm border border-slate-200" style="background-color: #ef4444"></label>
                </div>
            
                <div class="relative">
                    <input type="radio" name="color" id="col-2" value="#f97316" class="peer hidden color-radio">
                    <label for="col-2" class="block w-10 h-10 rounded-full cursor-pointer transition-transform hover:scale-110 shadow-sm border border-slate-200" style="background-color: #f97316"></label>
                </div>
            
                <div class="relative">
                    <input type="radio" name="color" id="col-3" value="#f59e0b" class="peer hidden color-radio">
                    <label for="col-3" class="block w-10 h-10 rounded-full cursor-pointer transition-transform hover:scale-110 shadow-sm border border-slate-200" style="background-color: #f59e0b"></label>
                </div>
            
                <div class="relative">
                    <input type="radio" name="color" id="col-4" value="#22c55e" class="peer hidden color-radio">
                    <label for="col-4" class="block w-10 h-10 rounded-full cursor-pointer transition-transform hover:scale-110 shadow-sm border border-slate-200" style="background-color: #22c55e"></label>
                </div>
            
                <div class="relative">
                    <input type="radio" name="color" id="col-5" value="#14b8a6" class="peer hidden color-radio">
                    <label for="col-5" class="block w-10 h-10 rounded-full cursor-pointer transition-transform hover:scale-110 shadow-sm border border-slate-200" style="background-color: #14b8a6"></label>
                </div>
            
                <div class="relative">
                    <input type="radio" name="color" id="col-6" value="#3b82f6" class="peer hidden color-radio">
                    <label for="col-6" class="block w-10 h-10 rounded-full cursor-pointer transition-transform hover:scale-110 shadow-sm border border-slate-200" style="background-color: #3b82f6"></label>
                </div>
            
                <div class="relative">
                    <input type="radio" name="color" id="col-7" value="#6366f1" class="peer hidden color-radio">
                    <label for="col-7" class="block w-10 h-10 rounded-full cursor-pointer transition-transform hover:scale-110 shadow-sm border border-slate-200" style="background-color: #6366f1"></label>
                </div>
            
                <div class="relative">
                    <input type="radio" name="color" id="col-8" value="#a855f7" class="peer hidden color-radio">
                    <label for="col-8" class="block w-10 h-10 rounded-full cursor-pointer transition-transform hover:scale-110 shadow-sm border border-slate-200" style="background-color: #a855f7"></label>
                </div>
            
                <div class="relative">
                    <input type="radio" name="color" id="col-9" value="#ec4899" class="peer hidden color-radio">
                    <label for="col-9" class="block w-10 h-10 rounded-full cursor-pointer transition-transform hover:scale-110 shadow-sm border border-slate-200" style="background-color: #ec4899"></label>
                </div>
            
                <div class="relative custom-color-wrapper group">
                    <input type="radio" name="color" id="col-custom" value="custom" class="peer hidden color-radio">
                    <label for="col-custom" id="label-custom-color" class="block w-10 h-10 rounded-full bg-white cursor-pointer transition-transform hover:scale-110 shadow-sm border border-slate-200 flex items-center justify-center overflow-hidden">
                        <div class="w-full h-full bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 opacity-80"></div>
                    </label>
                    <input type="color" id="inp-custom-color" class="absolute inset-0 opacity-0 cursor-pointer" title="好きな色を選択">
                </div>
            </div>
                </div>

                <!-- ID Management -->
                <div class="border-t border-slate-100 pt-6 mt-4">
                    <div class="flex items-center justify-between cursor-pointer group hover:bg-slate-50 active:bg-slate-100 -mx-4 px-4 py-3 rounded-xl transition-colors select-none" onclick="toggleIdSection()">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="smartphone" class="lucide lucide-smartphone w-4 h-4 text-emerald-500"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"></rect><path d="M12 18h.01"></path></svg>
                            <label class="text-xs font-bold text-slate-600 cursor-pointer">端末連携・ID管理</label>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="chevron-down" id="icon-id-toggle" class="lucide lucide-chevron-down w-4 h-4 text-slate-400 transition-transform"><path d="m6 9 6 6 6-6"></path></svg>
                    </div>
                    
                    <div id="id-section" class="hidden mt-2 space-y-4">
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                            <p class="text-[10px] text-slate-400 mb-1.5">あなたのユーザーID</p>
                            <div class="flex gap-2">
                                <input type="text" id="inp-my-id" readonly="" class="flex-grow bg-white border border-slate-200 rounded-xl px-3 py-2 text-xs text-slate-500 font-mono focus:outline-none select-all">
                                <button onclick="copyMyId()" class="p-2 bg-white border border-slate-200 rounded-xl hover:bg-slate-100 text-slate-500 cursor-pointer">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="copy" class="lucide lucide-copy w-4 h-4"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                            <p class="text-[10px] text-blue-400 mb-1.5">別の端末のIDを入力して連携</p>
                            <div class="flex gap-2">
                                <input type="text" id="inp-import-id" class="flex-grow bg-white border border-blue-200 rounded-xl px-3 py-2 text-xs text-slate-600 font-mono focus:outline-none focus:border-blue-400" placeholder="IDを貼り付け">
                                <button onclick="importUserIdentity()" class="px-3 bg-blue-500 hover:bg-blue-600 text-white text-[10px] font-bold rounded-xl transition-colors whitespace-nowrap transform scale-90 origin-right cursor-pointer">
                                    設定
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer Buttons -->
                <div class="pt-8 pb-10 flex flex-col gap-3 items-center">
                    <button onclick="handleSaveProfile()" class="w-full max-w-[240px] py-4 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-2xl shadow-lg shadow-emerald-500/30 active:scale-95 transition-all cursor-pointer">
                        保存する
                    </button>
                    <button onclick="closeProfileModal()" class="w-full max-w-[240px] py-3 text-slate-400 hover:text-slate-600 font-bold text-sm rounded-xl transition-colors cursor-pointer">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Saved Modal (Success Feedback) -->
    <div id="saved-modal" class="fixed inset-0 z-[70] flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300">
        <div class="bg-slate-800/90 text-white px-8 py-6 rounded-3xl backdrop-blur-md shadow-2xl flex flex-col items-center gap-3 transform scale-95 transition-transform duration-300" id="saved-modal-content">
            <div class="w-12 h-12 bg-emerald-500 rounded-full flex items-center justify-center text-white shadow-glow mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="check" class="lucide lucide-check w-6 h-6 stroke-[3]"><path d="M20 6 9 17l-5-5"></path></svg>
            </div>
            <p class="font-bold text-lg">保存しました</p>
        </div>
    </div>

    <!-- Comments Modal (Full List) -->
    <div id="comments-modal" class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center modal-enter transition-all duration-300">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity duration-300" onclick="closeCommentsModal()"></div>
        <div class="modal-content relative w-full max-w-lg bg-white sm:rounded-[32px] rounded-t-[32px] shadow-2xl overflow-hidden flex flex-col h-[85dvh] sm:h-[80vh] transition-transform duration-300">
            <!-- Header -->
            <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100 bg-white sticky top-0 z-[60]">
                <div>
                    <h3 class="font-bold text-lg text-slate-800">コメント</h3>
                    <p class="text-[10px] text-slate-400" id="comments-modal-subtitle">全件表示</p>
                </div>
                <!-- Enhanced Close Button -->
                <button onclick="closeCommentsModal()" class="p-2 -mr-2 bg-slate-100/80 hover:bg-slate-200 text-slate-500 hover:text-slate-700 rounded-full transition-colors relative z-50 cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="x" class="lucide lucide-x w-5 h-5"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                </button>
            </div>

            <!-- List Area -->
            <div class="flex-grow overflow-y-auto p-5 space-y-4" id="comments-list-full">
                <!-- Injected via JS -->
            </div>

            <!-- Footer Input -->
            <div class="p-4 border-t border-slate-100 bg-slate-50/80 backdrop-blur pb-8 sm:pb-4 pr-4 flex-shrink-0">
                <div class="flex gap-2 items-end">
                    <!-- Cancel Edit Button (Hidden by default) -->
                    <button id="btn-cancel-edit" onclick="cancelEditComment()" class="hidden mb-0.5 p-2 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-200 transition-all cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="x-circle" class="lucide lucide-x-circle w-6 h-6"><circle cx="12" cy="12" r="10"></circle><path d="m15 9-6 6"></path><path d="m9 9 6 6"></path></svg>
                    </button>

                    <!-- Resizable Textarea -->
                    <textarea id="inp-modal-comment" rows="1" class="flex-grow bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-emerald-400 focus:ring-4 focus:ring-emerald-100 transition-all resize-none overflow-hidden max-h-32" placeholder="コメントを入力..."></textarea>
                    
                    <!-- Fixed onclick removal -->
                    <button id="btn-modal-send-comment" class="bg-emerald-500 text-white px-4 py-3 rounded-xl font-bold hover:bg-emerald-600 active:scale-95 transition-all flex-shrink-0 mb-0.5 mr-1 h-[46px] flex items-center justify-center min-w-[46px] cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="send" class="lucide lucide-send w-5 h-5"><path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"></path><path d="m21.854 2.147-10.94 10.939"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Comments Modal (Drawer) -->
    <div id="recent-comments-modal" class="fixed inset-0 z-[60] flex items-end sm:items-start justify-end modal-enter transition-all duration-300">
        <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm transition-opacity duration-300" onclick="closeRecentCommentsModal()"></div>
        <div class="modal-content relative w-full sm:w-96 bg-white sm:m-4 sm:rounded-2xl rounded-t-[32px] shadow-2xl overflow-hidden flex flex-col h-[80dvh] sm:h-[calc(100vh-2rem)] transition-transform duration-300">
             <div class="flex items-center justify-between px-5 py-4 border-b border-slate-100 bg-slate-50 sticky top-0 z-10">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="message-square" class="lucide lucide-message-square w-5 h-5 text-slate-400"><path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"></path></svg>
                    <h3 class="font-bold text-slate-800">新着コメント</h3>
                </div>
                <button onclick="closeRecentCommentsModal()" class="p-2 -mr-2 bg-white hover:bg-slate-100 text-slate-400 hover:text-slate-600 rounded-full transition-colors border border-slate-100 cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="x" class="lucide lucide-x w-5 h-5"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto p-0" id="recent-comments-list"></div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 transform transition-all duration-500 z-[70] pointer-events-none border border-slate-700/50 backdrop-blur-md opacity-0 -translate-y-48 shadow-none">
        <div class="w-5 h-5 bg-emerald-500 rounded-full flex items-center justify-center text-white flex-shrink-0 shadow-glow">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="check" class="lucide lucide-check w-3 h-3 stroke-[3]"><path d="M20 6 9 17l-5-5"></path></svg>
        </div>
        <p class="font-bold text-sm tracking-wide" id="toast-msg">HTMLファイルを保存しました</p>
    </div>

    <p id="display-nickname-hint" style="display:none;">ゲスト</p>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, setDoc, getDoc, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Config ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Constants ---
        const CATEGORIES = ["グルメ", "ビジネス", "エンタメ", "小ネタ", "その他"];
        const AVATAR_COLORS = [
            '#94a3b8', '#ef4444', '#f97316', '#f59e0b', 
            '#22c55e', '#14b8a6', '#3b82f6', '#6366f1', 
            '#a855f7', '#ec4899'
        ];
        
        // --- State ---
        const state = {
            user: null, 
            customUserId: null, 
            nickname: 'ゲスト',
            color: '#94a3b8',
            userProfiles: {}, 
            items: [],
            comments: [], 
            recentComments: [], 
            editingItemId: null,
            activeCommentItemId: null,
            editingCommentId: null, 
            filter: 'all',
            isInitialLoad: true,
            newCommentsCount: 0,
            initialFormState: { title: '', url: '', memo: '', category: null }
        };

        // --- DOM Elements ---
        const els = {
            inpUrl: document.getElementById('inp-url'),
            inpTitle: document.getElementById('inp-title'),
            inpMemo: document.getElementById('inp-memo'),
            memoCounter: document.getElementById('memo-counter'),
            categorySelector: document.getElementById('category-selector'),
            categoryErrorMsg: document.getElementById('category-error-msg'),
            btnSave: document.getElementById('btn-save'),
            btnFab: document.getElementById('btn-fab'),
            btnAutoFetch: document.getElementById('btn-auto-fetch'),
            displayNicknameHint: document.getElementById('display-nickname-hint'),
            
            modal: document.getElementById('post-modal'),
            modalTitle: document.getElementById('modal-title'),
            
            profileModal: document.getElementById('profile-modal'),
            inpProfileNickname: document.getElementById('inp-profile-nickname'),
            colorPickerContainer: document.getElementById('color-picker-container'),
            inpMyId: document.getElementById('inp-my-id'),
            inpImportId: document.getElementById('inp-import-id'),
            idSection: document.getElementById('id-section'),
            iconIdToggle: document.getElementById('icon-id-toggle'),
            savedModal: document.getElementById('saved-modal'),
            savedModalContent: document.getElementById('saved-modal-content'),

            commentsModal: document.getElementById('comments-modal'),
            commentsListFull: document.getElementById('comments-list-full'),
            inpModalComment: document.getElementById('inp-modal-comment'),
            btnModalSendComment: document.getElementById('btn-modal-send-comment'),
            btnCancelEdit: document.getElementById('btn-cancel-edit'), 
            commentsModalSubtitle: document.getElementById('comments-modal-subtitle'),

            recentCommentsModal: document.getElementById('recent-comments-modal'),
            recentCommentsList: document.getElementById('recent-comments-list'),
            badgeComments: document.getElementById('badge-comments'),

            container: document.getElementById('cards-container'),
            empty: document.getElementById('empty-state'),
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toast-msg'),
            currentUserName: document.getElementById('current-user-name'),
            currentUserAvatar: document.getElementById('current-user-avatar'),
            filterContainer: document.getElementById('filter-container'),
            appHeaderTitle: document.getElementById('app-header-title'),
            appHeaderWrapper: document.getElementById('app-header-wrapper'),
            splashScreen: document.getElementById('splash-screen'),
            headerSpacer: document.getElementById('header-spacer')
        };

        // --- Init ---
        function init() {
            try {
                initCustomId(); 
                renderCategoryInputs();
                renderCategoryFilters();
                renderColorPicker();
                initAuth();
                setupEventListeners();
                lucide.createIcons();
                
                const minSplashTime = 1200; 
                const start = Date.now();

                const hideSplash = () => {
                    if (!els.splashScreen) return;
                    const elapsed = Date.now() - start;
                    const remaining = Math.max(0, minSplashTime - elapsed);
                    
                    setTimeout(() => {
                        els.splashScreen.classList.add('opacity-0', 'pointer-events-none');
                        setTimeout(() => {
                            if(els.splashScreen) els.splashScreen.remove();
                        }, 500);
                    }, remaining);
                };

                setTimeout(hideSplash, 3000);

                if (document.readyState === 'complete') {
                    hideSplash();
                } else {
                    window.addEventListener('load', hideSplash);
                }
            } catch (e) {
                console.error("Init failed:", e);
                if(els.splashScreen) els.splashScreen.remove();
            }
        }

        // --- Global Functions for inline events ---
        // モジュールスコープからwindowオブジェクトへ確実に関数を公開
        window.openCommentsModal = (itemId) => {
            console.log("openCommentsModal clicked", itemId);
            state.activeCommentItemId = itemId;
            const item = state.items.find(i => i.id === itemId);
            els.commentsModalSubtitle.textContent = item ? item.title : '';
            els.commentsModal.classList.remove('translate-y-full');
            els.commentsModal.classList.add('translate-y-0');
            renderCommentsModalList();
        };

        window.openPostModal = openPostModal;
        window.deleteItem = deleteItem;
        window.openUrl = (url) => {
             if (url) window.open(url, '_blank');
        };

        // --- Custom ID ---
        function initCustomId() {
            let storedId = localStorage.getItem('linkpocket_custom_id');
            if (!storedId) {
                storedId = crypto.randomUUID();
                localStorage.setItem('linkpocket_custom_id', storedId);
            }
            state.customUserId = storedId;
            els.inpMyId.value = storedId;
        }

        window.copyMyId = () => {
            const id = els.inpMyId.value;
            navigator.clipboard.writeText(id).then(() => showToast("IDをコピーしました")).catch(() => {
                els.inpMyId.select(); document.execCommand('copy'); showToast("IDをコピーしました");
            });
        };

        window.toggleIdSection = () => {
            els.idSection.classList.toggle('hidden');
            els.iconIdToggle.classList.toggle('rotate-180');
        };

        window.importUserIdentity = async () => {
            const newId = els.inpImportId.value.trim();
            if (!newId) return;
            if (newId === state.customUserId) { showToast("現在のIDと同じです", true); return; }
            if (!confirm("IDを変更しますか？\n（現在のIDは上書きされます）")) return;
            localStorage.setItem('linkpocket_custom_id', newId);
            state.customUserId = newId;
            showToast("IDを切り替えました");
            await loadOwnProfile(); 
            closeProfileModal();
            els.inpImportId.value = '';
            els.inpMyId.value = newId;
        };

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth failed", e);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.user = user;
                subscribeData(); 
                els.btnFab.disabled = false;
            } else {
                els.btnFab.disabled = true;
            }
        });

        async function loadOwnProfile() {
             if (state.userProfiles[state.customUserId]) {
                 const p = state.userProfiles[state.customUserId];
                 state.nickname = p.nickname;
                 state.color = p.color;
                 updateUserDisplay();
             }
        }

        async function saveUserProfileFromModal() {
            const newName = els.inpProfileNickname.value.trim();
            let newColor = '#94a3b8';

            const colorRadio = document.querySelector('input[name="color"]:checked');
            if (colorRadio) {
                if (colorRadio.value === 'custom') {
                    const inpCustom = document.getElementById('inp-custom-color');
                    newColor = inpCustom ? inpCustom.value : '#94a3b8';
                } else {
                    newColor = colorRadio.value;
                }
            } else {
                 showToast("色を選択してください", true); return;
            }

            if (!newName) { showToast("名前を入力してください", true); return; }
            
            if (!state.customUserId) return;
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', state.customUserId);
            try {
                await setDoc(userRef, { nickname: newName, color: newColor }, { merge: true });
                state.nickname = newName;
                state.color = newColor;
                closeProfileModal();
                showSavedModal();
            } catch (e) { console.error("Profile save error", e); }
        }
        window.handleSaveProfile = saveUserProfileFromModal;

        function subscribeData() {
            const profilesRef = collection(db, 'artifacts', appId, 'public', 'data', 'user_profiles');
            onSnapshot(profilesRef, (snapshot) => {
                const newProfiles = {};
                snapshot.forEach(doc => {
                    newProfiles[doc.id] = doc.data();
                });
                state.userProfiles = newProfiles;
                
                if (state.customUserId && state.userProfiles[state.customUserId]) {
                    const p = state.userProfiles[state.customUserId];
                    state.nickname = p.nickname;
                    state.color = p.color;
                    updateUserDisplay();
                }

                renderCards();
                if (state.activeCommentItemId) renderCommentsModalList();
                renderRecentCommentsList();
            });

            const itemsRef = collection(db, 'artifacts', appId, 'public', 'data', 'items');
            const itemsQ = query(itemsRef, orderBy('date', 'desc'));
            onSnapshot(itemsQ, (snapshot) => {
                state.items = [];
                snapshot.forEach(doc => state.items.push({ id: doc.id, ...doc.data() }));
                renderCards();
            });

            const commentsRef = collection(db, 'artifacts', appId, 'public', 'data', 'comments');
            onSnapshot(commentsRef, (snapshot) => {
                const changes = snapshot.docChanges();
                state.comments = [];
                snapshot.forEach(doc => state.comments.push({ id: doc.id, ...doc.data() }));
                if (!state.isInitialLoad) {
                    // Filter out comments authored by the current user from the badge count
                    const addedCount = changes.filter(c => {
                        const data = c.doc.data();
                        return c.type === 'added' && data.authorId !== state.customUserId;
                    }).length;

                    if (addedCount > 0) {
                        state.newCommentsCount += addedCount;
                        updateBadge();
                    }
                }
                state.isInitialLoad = false;
                if (state.activeCommentItemId) renderCommentsModalList();
                renderCards(); 
                renderRecentCommentsList();
            });
        }

        function getUserProfile(uid) {
            const p = state.userProfiles[uid];
            if (p) return { name: p.nickname, color: p.color };
            return { name: 'Guest', color: '#94a3b8' };
        }

        async function handleAutoFetch() {
            const url = els.inpUrl.value.trim();
            if (!url) { showToast("URLを入力してください", true); return; }
            els.btnAutoFetch.disabled = true;
            const originalIcon = els.btnAutoFetch.innerHTML;
            els.btnAutoFetch.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>`;
            lucide.createIcons();
            try {
                const res = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}&palette=true`);
                const json = await res.json();
                if (json.status === 'success') {
                    const data = json.data;
                    if (data.title) {
                        els.inpTitle.value = data.title;
                        els.inpTitle.classList.add('bg-blue-50', 'border-blue-200');
                        setTimeout(() => els.inpTitle.classList.remove('bg-blue-50', 'border-blue-200'), 1000);
                        els.inpTitle.dispatchEvent(new Event('input'));
                    }
                    if (data.description && !els.inpMemo.value) {
                        els.inpMemo.value = data.description.substring(0, 100);
                        els.memoCounter.textContent = els.inpMemo.value.length;
                    }
                    showToast("情報を取得しました");
                } else { showToast("情報を取得できませんでした", true); }
            } catch (e) { showToast("取得エラーが発生しました", true); } 
            finally {
                els.btnAutoFetch.disabled = false;
                els.btnAutoFetch.innerHTML = originalIcon;
                lucide.createIcons();
            }
        }

        // --- Modals ---
        function openPostModal(itemId = null) {
            resetForm();
            els.modal.classList.remove('modal-enter');
            els.modal.classList.add('modal-active');
            if (itemId) {
                const item = state.items.find(i => i.id === itemId);
                if (item) {
                    state.editingItemId = itemId;
                    els.modalTitle.textContent = "メモを編集";
                    els.inpTitle.value = item.title;
                    els.inpUrl.value = item.url || '';
                    els.inpMemo.value = item.memo || '';
                    els.memoCounter.textContent = item.memo ? item.memo.length : 0;
                    const cat = item.category || 'その他';
                    const radio = document.querySelector(`input[name="category"][value="${cat}"]`);
                    if (radio) {
                        radio.checked = true;
                        els.categorySelector.dispatchEvent(new Event('change'));
                    }
                    els.btnSave.innerHTML = `<span>更新する</span><i data-lucide="check" class="w-4 h-4 ml-1"></i>`;
                }
            } else {
                state.editingItemId = null;
                els.modalTitle.textContent = "メモを追加";
                els.btnSave.innerHTML = `<span>保存する</span><i data-lucide="send" class="w-4 h-4 ml-1"></i>`;
            }
            
            state.initialFormState = {
                title: els.inpTitle.value,
                url: els.inpUrl.value,
                memo: els.inpMemo.value,
                category: document.querySelector('input[name="category"]:checked')?.value || null
            };
            
            lucide.createIcons();
        };

        function isFormDirty() {
            const currentCategory = document.querySelector('input[name="category"]:checked')?.value || null;
            if (els.inpTitle.value !== state.initialFormState.title) return true;
            if (els.inpUrl.value !== state.initialFormState.url) return true;
            if (els.inpMemo.value !== state.initialFormState.memo) return true;
            if (currentCategory !== state.initialFormState.category) return true;
            return false;
        }

        function closePostModal(force = false) {
            if (!force && isFormDirty()) {
                if (!confirm("入力中の内容があります。破棄して閉じますか？")) return;
            }
            els.modal.classList.remove('modal-active');
            els.modal.classList.add('modal-enter');
            setTimeout(resetForm, 300);
        };
        window.closePostModal = closePostModal;

        window.openProfileModal = () => {
            els.inpProfileNickname.value = state.nickname;
            
            const radio = document.querySelector(`input[name="color"][value="${state.color}"]`);
            if (radio) {
                radio.checked = true;
            }
            
            const customRadio = document.getElementById('col-custom');
            const customLabel = document.getElementById('label-custom-color');
            const customInput = document.getElementById('inp-custom-color');
            
            if (!radio && customRadio && customLabel && customInput) {
                customRadio.checked = true;
                customInput.value = state.color;
                customLabel.style.background = state.color;
                customLabel.innerHTML = '';
            } else if (customLabel) {
                customLabel.style.background = `white`;
                customLabel.innerHTML = '<div class="w-full h-full bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 opacity-80"></div>';
            }

            els.profileModal.classList.remove('translate-y-full');
            els.profileModal.classList.add('translate-y-0');
        };

        window.closeProfileModal = () => {
            els.profileModal.classList.remove('translate-y-0');
            els.profileModal.classList.add('translate-y-full');
        };

        window.closeCommentsModal = (force = false) => {
            const inputVal = els.inpModalComment.value.trim();
            if (!force && inputVal.length > 0 && !state.editingCommentId) { // Only prompt if new comment
                 if (!confirm("入力中のコメントがあります。破棄して閉じますか？")) return;
            }
            els.commentsModal.classList.remove('translate-y-0');
            els.commentsModal.classList.add('translate-y-full');
            
            // Clean up
            cancelEditComment();
            state.activeCommentItemId = null;
            if(!force) setTimeout(() => { els.inpModalComment.value = ''; els.inpModalComment.style.height = 'auto'; }, 300);
        };

        window.openRecentCommentsModal = () => {
            state.newCommentsCount = 0; 
            updateBadge();
            els.recentCommentsModal.classList.remove('modal-enter');
            els.recentCommentsModal.classList.add('modal-active');
            renderRecentCommentsList();
        };

        window.closeRecentCommentsModal = () => {
            els.recentCommentsModal.classList.remove('modal-active');
            els.recentCommentsModal.classList.add('modal-enter');
        };

        // --- Actions ---
        async function handleSave() {
            const title = els.inpTitle.value.trim();
            const url = els.inpUrl.value.trim();
            const memo = els.inpMemo.value.trim();
            const catRadio = document.querySelector('input[name="category"]:checked');

            if (!catRadio) {
                // Vibrate button
                els.btnSave.classList.add('animate-vibrate');
                setTimeout(() => els.btnSave.classList.remove('animate-vibrate'), 300);
                
                els.categorySelector.classList.add('category-error');
                els.categoryErrorMsg.classList.remove('hidden');
                showToast("カテゴリを選択してください", true);
                return;
            }
            const category = catRadio.value;

            if (!title) {
                els.btnSave.classList.add('animate-vibrate');
                setTimeout(() => els.btnSave.classList.remove('animate-vibrate'), 300);
                
                els.inpTitle.focus();
                els.inpTitle.classList.add('ring-4', 'ring-red-100', 'border-red-400');
                showToast("タイトルを入力してください", true);
                return;
            }

            const originalBtnHtml = els.btnSave.innerHTML;
            
            els.btnSave.disabled = true;
            els.btnSave.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>`;
            lucide.createIcons();

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', state.customUserId), {
                    nickname: state.nickname,
                    color: state.color
                }, { merge: true });

                let thumbnail = '';
                if (url) {
                     if (state.editingItemId) {
                         const existing = state.items.find(i => i.id === state.editingItemId);
                         if (existing && existing.url === url) thumbnail = existing.thumbnail;
                    }
                    if (!thumbnail) {
                        try {
                            const res = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}&palette=true`);
                            const json = await res.json();
                            if (json.status === 'success') thumbnail = json.data.image?.url || '';
                        } catch(e){}
                    }
                }

                const docData = {
                    title, url, memo, category, thumbnail,
                    authorId: state.customUserId
                };

                if (state.editingItemId) {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'items', state.editingItemId);
                    await updateDoc(ref, { ...docData, updatedAt: serverTimestamp() });
                } else {
                    const ref = collection(db, 'artifacts', appId, 'public', 'data', 'items');
                    await addDoc(ref, { ...docData, date: serverTimestamp() });
                }
                
                closePostModal(true);
                
                if (state.editingItemId) {
                    showToast("更新しました");
                } else {
                    showToast("追加しました");
                }

            } catch (e) {
                console.error(e);
                showToast("エラーが発生しました", true);
            } finally {
                els.btnSave.disabled = false;
                els.btnSave.innerHTML = originalBtnHtml;
                lucide.createIcons();
            }
        }

        // Renamed to support both add and edit
        async function handleCommentSubmit() {
            const text = els.inpModalComment.value.trim();
            if (!text) return;

            if (state.editingCommentId) {
                // Update existing comment
                try {
                    const commentRef = doc(db, 'artifacts', appId, 'public', 'data', 'comments', state.editingCommentId);
                    await updateDoc(commentRef, { text: text });
                    showToast("コメントを更新しました");
                    cancelEditComment();
                } catch(e) { showToast("更新に失敗しました", true); }
            } else {
                // Add new comment
                if (!state.activeCommentItemId) return;
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', state.customUserId), {
                        nickname: state.nickname,
                        color: state.color
                    }, { merge: true });

                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'comments'), {
                        itemId: state.activeCommentItemId,
                        text: text,
                        authorId: state.customUserId,
                        date: serverTimestamp()
                    });
                    els.inpModalComment.value = '';
                    els.inpModalComment.style.height = 'auto';
                } catch (e) { showToast("送信失敗", true); }
            }
        }
        window.handleCommentSubmit = handleCommentSubmit;

        // Edit Comment Logic
        window.startEditComment = (id, text) => {
            state.editingCommentId = id;
            els.inpModalComment.value = text;
            els.inpModalComment.focus();
            // Trigger height adjust
            els.inpModalComment.style.height = 'auto';
            els.inpModalComment.style.height = (els.inpModalComment.scrollHeight) + 'px';
            
            // Change UI
            els.btnCancelEdit.classList.remove('hidden');
            els.btnModalSendComment.innerHTML = `<i data-lucide="check" class="w-5 h-5"></i>`;
            lucide.createIcons();
        };

        window.cancelEditComment = () => {
            state.editingCommentId = null;
            els.inpModalComment.value = '';
            els.inpModalComment.style.height = 'auto';
            
            // Reset UI
            els.btnCancelEdit.classList.add('hidden');
            els.btnModalSendComment.innerHTML = `<i data-lucide="send" class="w-5 h-5"></i>`;
            lucide.createIcons();
        };

        async function deleteItem(id) {
            if (!confirm("削除しますか？")) return;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', id)); showToast("削除しました"); } catch (e) {}
        }
        window.deleteItem = deleteItem;

        async function deleteComment(id) {
            if (!confirm("コメントを削除しますか？")) return;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'comments', id)); } catch(e) {}
        }
        window.deleteComment = deleteComment;
        
        window.scrollToItem = (itemId) => {
            closeRecentCommentsModal();
            const card = document.getElementById(`card-${itemId}`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                card.classList.remove('highlight-card');
                void card.offsetWidth; 
                card.classList.add('highlight-card');
            } else { showToast("対象のメモが見つかりません", true); }
        }

        function renderCards() {
            const container = els.container;
            container.innerHTML = '';
            
            const filtered = state.filter === 'all' 
                ? state.items 
                : state.items.filter(i => i.category === state.filter);

            if (filtered.length === 0) {
                els.empty.classList.remove('hidden');
                return;
            }
            els.empty.classList.add('hidden');

            filtered.forEach((item, index) => {
                const itemComments = state.comments
                    .filter(c => c.itemId === item.id)
                    .sort((a, b) => (a.date?.seconds || 0) - (b.date?.seconds || 0));
                container.appendChild(createCardElement(item, itemComments, index));
            });
            lucide.createIcons();
        }

        function createCardElement(item, comments, index) {
            const isOwner = state.customUserId && item.authorId === state.customUserId;
            const profile = getUserProfile(item.authorId);
            
            // 1. カードのコンテナ作成
            const card = document.createElement('div');
            card.id = `card-${item.id}`;
            card.className = "bg-white rounded-[24px] overflow-hidden flex flex-col shadow-sm border border-slate-200 transition-opacity duration-300 opacity-0 animate-pop-in relative";
            card.style.animationDelay = `${Math.min(index * 0.05, 0.5)}s`;

            let imgHTML = '';
            if (item.thumbnail) {
                imgHTML = `<div class="relative h-40 bg-slate-100 overflow-hidden pointer-events-none"><img src="${item.thumbnail}" class="w-full h-full object-cover" loading="lazy"></div>`;
            } else {
                imgHTML = `<div class="h-28 bg-slate-50 flex items-center justify-center pointer-events-none"><i data-lucide="ghost" class="text-slate-200 w-8 h-8"></i></div>`;
            }

            const d = item.date ? (item.date.toDate ? item.date.toDate() : new Date(item.date)) : new Date();
            const dateStr = `${d.getMonth()+1}月${d.getDate()}日`;

            const recent3 = comments.slice(-3);
            const commentsHTML = recent3.map(c => {
                const cProfile = getUserProfile(c.authorId);
                return `
                <div class="flex items-start gap-1.5 text-xs py-0.5 pointer-events-none">
                    <div class="flex-grow min-w-0">
                        <span class="font-bold text-slate-700">${cProfile.name}：</span>
                        <span class="text-slate-600 truncate block">${c.text}</span>
                    </div>
                </div>`;
            }).join('');
            
            const commentCount = comments.length;

            // ボタンHTMLを作成 (インラインイベントハンドラを使用)
            let btnHtml = '';
            if (commentCount > 0) {
                btnHtml = `
                <div class="relative z-[100]" style="pointer-events: auto;">
                    <button type="button" onclick="event.preventDefault(); event.stopPropagation(); console.log('OPEN_MODAL'); window.openCommentsModal('${item.id}');" class="w-full py-2.5 text-[10px] font-bold rounded-lg transition-colors flex items-center justify-center gap-1 cursor-pointer bg-white border border-slate-200 hover:bg-slate-50 shadow-sm text-slate-500">
                        <span>コメントをすべて見る</span>
                        <span class="bg-slate-100 px-1.5 rounded-full text-[10px]">${commentCount}</span>
                    </button>
                </div>`;
            } else {
                btnHtml = `
                <div class="relative z-[100]" style="pointer-events: auto;">
                    <button type="button" onclick="event.preventDefault(); event.stopPropagation(); console.log('OPEN_MODAL'); window.openCommentsModal('${item.id}');" class="w-full py-2.5 text-[10px] font-bold rounded-lg transition-colors flex items-center justify-center gap-1 cursor-pointer bg-white hover:bg-slate-50 border border-dashed border-slate-200 text-slate-400">
                        <i data-lucide="plus" class="w-3 h-3"></i>
                        <span>コメントを追加</span>
                    </button>
                </div>`;
            }

            // タイトルHTML（URLがあればリンク化）
            const titleHtml = item.url ? 
                `<a href="${item.url}" target="_blank" rel="noopener noreferrer" class="hover:text-blue-600 transition-colors cursor-pointer break-all flex items-start gap-1" style="pointer-events: auto; position: relative; z-index: 100;">
                    <span>${item.title}</span>
                    <i data-lucide="external-link" class="inline w-3.5 h-3.5 mt-1 text-slate-300 flex-shrink-0"></i>
                </a>` : 
                `<span class="break-all">${item.title}</span>`;

            // 編集・削除ボタンのHTML（オーナーのみ）
            let actionsHtml = '';
            if (isOwner) {
                actionsHtml = `
                <div class="absolute top-3 right-3 flex items-center bg-white/90 backdrop-blur rounded-full px-2 py-1 shadow-sm border border-slate-100 z-50 pointer-events-auto">
                    <button type="button" onclick="event.stopPropagation(); openPostModal('${item.id}')" class="p-1 text-slate-400 hover:text-blue-500 rounded-full transition-colors cursor-pointer">
                        <i data-lucide="edit-2" class="w-3.5 h-3.5"></i>
                    </button>
                    <div class="w-px h-3 bg-slate-200 mx-1"></div>
                    <button type="button" onclick="event.stopPropagation(); deleteItem('${item.id}')" class="p-1 text-slate-400 hover:text-red-500 rounded-full transition-colors cursor-pointer">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                    </button>
                </div>`;
            }

            // 究極的にシンプルに
            // 親要素のポインターイベント制御や不要なラッパーを削除し、ボタンを直接埋め込む
            card.innerHTML = `
                <div class="relative z-0">
                    ${imgHTML}
                    ${actionsHtml}
                    <div class="absolute top-3.5 left-3 z-10 flex items-center justify-center pointer-events-none">
                        <div class="px-2 py-1 bg-white/90 backdrop-blur text-xs font-bold text-slate-600 rounded-lg shadow-sm border border-slate-100 h-[26px] flex items-center justify-center">
                            ${item.category || 'その他'}
                        </div>
                    </div>
                </div>
                <div class="p-4 flex flex-col flex-grow relative z-10 bg-white">
                    <div class="mb-1 relative">
                        <h3 class="font-bold text-slate-800 text-lg leading-snug">
                            ${titleHtml}
                        </h3>
                    </div>
                    ${item.memo ? `<div class="text-sm text-slate-500 mt-2 leading-relaxed p-1 whitespace-pre-wrap line-clamp-3 pointer-events-none">${item.memo}</div>` : ''}
                    
                    <div class="mt-auto pt-4 relative">
                        <div class="flex items-center justify-between text-xs text-slate-400 font-bold mb-3 px-1 pointer-events-none">
                            <div class="flex items-center gap-1.5">
                                <div class="w-5 h-5 rounded-full flex items-center justify-center text-[9px] text-white font-bold shadow-sm border border-white" style="background-color: ${profile.color}">${profile.name.slice(0,1)}</div>
                                <span>${profile.name}</span>
                            </div>
                            <span>${dateStr}</span>
                        </div>
                        
                        <!-- Comment Section Container -->
                        <div class="bg-slate-50/80 rounded-2xl p-3 border border-slate-100 relative">
                            <div class="flex items-center gap-2 mb-2 px-1 pointer-events-none">
                                <i data-lucide="message-circle" class="w-3.5 h-3.5 text-slate-400"></i>
                                <span class="text-xs font-bold text-slate-500">コメント</span>
                            </div>
                            ${commentCount > 0 ? `<div class="space-y-1 mb-1 pointer-events-none">${commentsHTML}</div>` : '<p class="text-[10px] text-slate-400 px-1 pointer-events-none">まだコメントはありません</p>'}
                            
                            <!-- ボタン配置 -->
                            <div class="mt-2 relative z-50">
                                ${btnHtml}
                            </div>
                        </div>
                    </div>
                </div>`;

            return card;
        }

        function renderCommentsModalList() {
            if (!state.activeCommentItemId) return;
            const list = state.comments
                .filter(c => c.itemId === state.activeCommentItemId)
                .sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0)); // Descending sort

            els.commentsListFull.innerHTML = list.map(c => {
                const cProfile = getUserProfile(c.authorId);
                const isMyComment = state.customUserId && c.authorId === state.customUserId;
                const d = c.date ? (c.date.toDate ? c.date.toDate() : new Date(c.date)) : new Date();
                const dateStr = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                
                return `
                <div class="flex gap-3 group border-b border-slate-100 py-3 px-4">
                    <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-xs font-bold text-white shadow-sm border border-white" style="background-color: ${cProfile.color}">${cProfile.name.slice(0,1)}</div>
                    <div class="flex-grow">
                        <div class="flex items-baseline justify-between">
                            <span class="text-sm font-bold text-slate-700">${cProfile.name}</span>
                            <span class="text-[10px] text-slate-400">${dateStr}</span>
                        </div>
                        <div class="text-sm text-slate-600 mt-0.5 whitespace-pre-wrap">${c.text}</div>
                        ${isMyComment ? `
                        <div class="flex gap-4 mt-2 justify-end">
                            <button onclick="startEditComment('${c.id}', '${c.text.replace(/'/g, "\\'").replace(/\n/g, "\\n")}')" class="p-1 text-slate-400 hover:text-blue-500 transition-colors cursor-pointer">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteComment('${c.id}')" class="p-1 text-slate-400 hover:text-red-500 transition-colors cursor-pointer">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>` : ''}
                    </div>
                </div>`;
            }).join('');
            
            // Auto scroll to top since order is descending now (newest first)
            els.commentsListFull.scrollTop = 0;
            lucide.createIcons();
        }

        function renderRecentCommentsList() {
            const sorted = [...state.comments].sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0)).slice(0, 50);
            
            els.recentCommentsList.innerHTML = sorted.map(c => {
                const item = state.items.find(i => i.id === c.itemId);
                if (!item) return '';
                
                const cProfile = getUserProfile(c.authorId);
                const d = c.date ? (c.date.toDate ? c.date.toDate() : new Date(c.date)) : new Date();
                const dateStr = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                
                return `
                <div class="p-4 border-b border-slate-50 hover:bg-slate-50 transition-colors cursor-pointer" onclick="scrollToItem('${c.itemId}')">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded-md truncate max-w-[150px]">${item.title}</span>
                        <span class="text-[10px] text-slate-400 ml-auto">${dateStr}</span>
                    </div>
                    <div class="flex gap-2 items-center">
                        <div class="w-6 h-6 rounded-full flex-shrink-0 flex items-center justify-center text-[10px] font-bold text-white mt-0.5 shadow-sm border border-white" style="background-color: ${cProfile.color}">${cProfile.name.slice(0,1)}</div>
                        <div class="text-xs text-slate-600 line-clamp-2"><span class="font-bold text-slate-700 mr-1">${cProfile.name}:</span>${c.text}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function updateBadge() {
            const count = state.newCommentsCount;
            if (count > 0) {
                els.badgeComments.textContent = count > 99 ? '99+' : count;
                els.badgeComments.classList.remove('opacity-0', 'scale-0');
                els.badgeComments.classList.add('animate-bounce-sm');
            } else {
                els.badgeComments.classList.add('opacity-0', 'scale-0');
            }
        }

        // --- Helpers ---
        function renderCategoryInputs() {
            els.categorySelector.innerHTML = CATEGORIES.map((cat, i) => `
                <div class="category-wrapper">
                    <input type="radio" name="category" id="cat-${i}" value="${cat}" class="category-input">
                    <label for="cat-${i}" class="block px-2.5 py-1 rounded-xl text-[10px] font-bold bg-slate-100 text-slate-500 border border-slate-200 transition-all hover:bg-white hover:shadow-sm select-none">
                        ${cat}
                    </label>
                </div>
            `).join('');
        }

        function renderCategoryFilters() {
            els.filterContainer.innerHTML = '';
            const allBtn = document.createElement('button');
            allBtn.className = "category-filter-btn active flex-shrink-0 px-2 py-1 text-[8px] font-bold text-emerald-600 border-b-2 border-emerald-500 transition-all cursor-pointer min-w-[32px] whitespace-nowrap";
            allBtn.textContent = "すべて";
            allBtn.dataset.cat = "all";
            allBtn.onclick = (e) => setCategoryFilter('all', e.currentTarget);
            els.filterContainer.appendChild(allBtn);

            CATEGORIES.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = "flex-shrink-0 px-1.5 py-1 text-[8px] font-bold text-slate-400 border-b-2 border-transparent hover:text-slate-600 transition-all cursor-pointer min-w-[32px] whitespace-nowrap";
                btn.dataset.cat = cat;
                btn.textContent = cat;
                btn.onclick = (e) => setCategoryFilter(cat, e.currentTarget);
                els.filterContainer.appendChild(btn);
            });
        }

        function renderColorPicker() {
            // Re-construct the full HTML including custom picker which was overwritten
            const presets = AVATAR_COLORS.map((col, i) => `
                <div class="relative">
                    <input type="radio" name="color" id="col-${i}" value="${col}" class="peer hidden color-radio">
                    <label for="col-${i}" class="block w-10 h-10 rounded-full cursor-pointer transition-transform hover:scale-110 shadow-sm border border-slate-200" style="background-color: ${col}"></label>
                </div>
            `).join('');
            
            const customPickerHTML = `
                <div class="relative custom-color-wrapper group">
                    <input type="radio" name="color" id="col-custom" value="custom" class="peer hidden color-radio">
                    <label for="col-custom" id="label-custom-color" class="block w-10 h-10 rounded-full bg-white cursor-pointer transition-transform hover:scale-110 shadow-sm border border-slate-200 flex items-center justify-center overflow-hidden">
                        <div class="w-full h-full bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 opacity-80"></div>
                    </label>
                    <input type="color" id="inp-custom-color" class="absolute inset-0 opacity-0 cursor-pointer" title="好きな色を選択">
                </div>
            `;
            
            els.colorPickerContainer.innerHTML = presets + customPickerHTML;
            
            // Re-bind listeners for the newly created elements
            const customInput = document.getElementById('inp-custom-color');
            const customRadio = document.getElementById('col-custom');
            const customLabel = document.getElementById('label-custom-color');
            
            if (customInput) {
                customInput.addEventListener('change', (e) => {
                    customRadio.checked = true;
                    customLabel.innerHTML = '';
                    customLabel.style.background = e.target.value;
                });
            }
        }

        window.setCategoryFilter = (cat, targetBtn) => {
            state.filter = cat;
            
            // Update styles
            document.querySelectorAll('#filter-container button').forEach(btn => {
                if (btn.dataset.cat === cat) {
                    btn.className = "category-filter-btn active flex-shrink-0 px-2 py-1 text-[8px] font-bold text-emerald-600 border-b-2 border-emerald-500 transition-all cursor-pointer min-w-[32px] whitespace-nowrap";
                } else {
                    btn.className = "flex-shrink-0 px-1.5 py-1 text-[8px] font-bold text-slate-400 border-b-2 border-transparent hover:text-slate-600 transition-all cursor-pointer min-w-[32px] whitespace-nowrap";
                }
            });

            // Smooth Scroll to Center
            if (targetBtn) {
                targetBtn.scrollIntoView({
                    behavior: 'smooth',
                    inline: 'center',
                    block: 'nearest'
                });
            } else {
                 // Fallback if targetBtn is not passed
                 const btn = document.querySelector(`#filter-container button[data-cat="${cat}"]`);
                 if(btn) {
                     btn.scrollIntoView({
                        behavior: 'smooth',
                        inline: 'center',
                        block: 'nearest'
                    });
                 }
            }

            renderCards();
        }

        function updateUserDisplay() {
            els.currentUserName.textContent = state.nickname;
            els.currentUserAvatar.className = `w-5 h-5 rounded-full flex items-center justify-center text-white text-[9px] font-bold transition-colors`;
            els.currentUserAvatar.style.backgroundColor = state.color;
            els.displayNicknameHint.textContent = state.nickname;
        }

        function resetForm() {
            els.inpTitle.value = '';
            els.inpUrl.value = '';
            els.inpMemo.value = '';
            els.memoCounter.textContent = '0';
            const radios = document.querySelectorAll('input[name="category"]');
            radios.forEach(r => r.checked = false);
            els.categorySelector.classList.remove('category-error');
            els.categoryErrorMsg.classList.add('hidden');
            // Remove title error
            els.inpTitle.classList.remove('ring-4', 'ring-red-100', 'border-red-400');
        }

        function showToast(msg, isError = false) {
            els.toastMsg.textContent = msg;
            const iconContainer = els.toast.querySelector('div');
            if (isError) {
                iconContainer.classList.replace('bg-emerald-500', 'bg-red-500');
                els.toast.querySelector('i').setAttribute('data-lucide', 'alert-circle');
            } else {
                iconContainer.classList.replace('bg-red-500', 'bg-emerald-500');
                els.toast.querySelector('i').setAttribute('data-lucide', 'check');
            }
            lucide.createIcons();
            
            // To avoid shadow leak, we manage opacity and position
            els.toast.classList.remove('opacity-0', '-translate-y-48', 'shadow-none');
            els.toast.classList.add('opacity-100', 'translate-y-0', 'shadow-2xl');
            
            setTimeout(() => {
                els.toast.classList.remove('opacity-100', 'translate-y-0', 'shadow-2xl');
                els.toast.classList.add('opacity-0', '-translate-y-48', 'shadow-none');
            }, 2500);
        }

        function showSavedModal() {
            els.savedModal.classList.remove('opacity-0', 'pointer-events-none');
            els.savedModalContent.classList.remove('scale-95');
            els.savedModalContent.classList.add('scale-100');
            
            setTimeout(() => {
                els.savedModalContent.classList.remove('scale-100');
                els.savedModalContent.classList.add('scale-95');
                els.savedModal.classList.add('opacity-0', 'pointer-events-none');
            }, 1500);
        }

        function downloadHTML() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'LinkPocket_Shared.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('HTMLファイルを保存しました');
        }
        
        function setupEventListeners() {
            els.btnSave.addEventListener('click', handleSave);
            els.btnFab.addEventListener('click', () => openPostModal());
            els.btnAutoFetch.addEventListener('click', handleAutoFetch);
            // Fixed the function name here
            els.btnModalSendComment.addEventListener('click', handleCommentSubmit);

            els.inpMemo.addEventListener('input', () => {
                els.memoCounter.textContent = els.inpMemo.value.length;
            });
            els.appHeaderTitle.addEventListener('click', () => {
                 location.reload();
            });
            // Handle Download Trigger
             const headerSpacer = document.getElementById('header-spacer');
            if(headerSpacer){
                headerSpacer.addEventListener('click', (e) => {
                     // 判定を緩和: ダブルクリック以上で反応するように変更
                     if (e.detail >= 2) { 
                         e.preventDefault(); 
                         downloadHTML(); 
                     }
                });
            }


            // Validation clearance with delegation for new dynamic structure
            els.categorySelector.addEventListener('change', (e) => {
                if (e.target.matches('input[name="category"]')) {
                     els.categorySelector.classList.remove('category-error', 'animate-bounce');
                     els.categoryErrorMsg.classList.add('hidden');
                }
            });
            
            els.inpTitle.addEventListener('input', () => {
                if (els.inpTitle.value.trim().length > 0) {
                    els.inpTitle.classList.remove('ring-4', 'ring-red-100', 'border-red-400');
                }
            });

            // Color picker listeners are now attached inside renderColorPicker due to dynamic HTML creation
            // except for preset listeners which bubble up to container
            els.colorPickerContainer.addEventListener('change', (e) => {
                if (e.target.name === 'color' && e.target.value !== 'custom') {
                    const customLabel = document.getElementById('label-custom-color');
                    if (customLabel) {
                        customLabel.style.background = `white`;
                        customLabel.innerHTML = '<div class="w-full h-full bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500 opacity-80"></div>';
                    }
                }
            });

            // Comment textarea resize
            els.inpModalComment.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // Removed createCardElement querySelector logic
            // Buttons now use inline onclick

            // Scroll Header Logic
            let lastScrollY = window.scrollY;
            const header = document.getElementById('app-header-wrapper');
            
            window.addEventListener('scroll', () => {
                const currentScrollY = window.scrollY;
                const docHeight = document.documentElement.scrollHeight;
                const winHeight = window.innerHeight;
                const scrollBottomLimit = docHeight - winHeight;

                // バウンススクロール対策
                if (currentScrollY < 0 || currentScrollY > scrollBottomLimit) {
                    lastScrollY = currentScrollY;
                    return;
                }
                
                if (currentScrollY > lastScrollY && currentScrollY > 100) {
                    // Down scroll & not at top -> Hide
                    header.style.transform = 'translateY(-100%)';
                } else if (currentScrollY < lastScrollY) {
                    // Up scroll -> Show
                    // バウンス戻り誤検知防止
                    if (currentScrollY < scrollBottomLimit - 100) {
                        header.style.transform = 'translateY(0)';
                    }
                }
                lastScrollY = currentScrollY;
            });
        }
        
        init();
        
        // Expose functions to window for inline onclick handlers
        window.openPostModal = openPostModal;
        window.closePostModal = closePostModal;
        window.openCommentsModal = openCommentsModal;
        window.closeCommentsModal = closeCommentsModal;
        window.openRecentCommentsModal = openRecentCommentsModal;
        window.closeRecentCommentsModal = closeRecentCommentsModal;
        window.deleteItem = deleteItem;
        window.deleteComment = deleteComment;
        window.startEditComment = startEditComment;
        window.cancelEditComment = cancelEditComment;
        window.handleSaveProfile = saveUserProfileFromModal;
        window.copyMyId = copyMyId;
        window.importUserIdentity = importUserIdentity;
        window.handleCommentSubmit = handleCommentSubmit;
        window.handleSave = handleSave;
        window.scrollToItem = scrollToItem;
        window.setCategoryFilter = setCategoryFilter;
        window.openProfileModal = openProfileModal;
        window.closeProfileModal = closeProfileModal;
        window.toggleIdSection = toggleIdSection;
        window.openUrl = openUrl;
        
    </script>

</body></html>